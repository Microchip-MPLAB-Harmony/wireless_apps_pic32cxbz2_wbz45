<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Multiprotocol (BLE+ZIGBEE) Concurrent Application - Tutorial" />
<meta name="DC.relation" scheme="URI" content="GUID-2A54CAC1-1370-4448-8768-E6C7B8CFCA23.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064" />
<meta name="DC.language" content="en-US" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>Multiprotocol (BLE+ZIGBEE) Concurrent Application - Tutorial</title>
<meta name="Microsoft.Help.Id" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064" />
<meta name="Microsoft.Help.TocParent" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-2A54CAC1-1370-4448-8768-E6C7B8CFCA23" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="Software Development Reference A 09/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064">
<h1 class="title topictitle1" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-653CE1B0-6179-4CF8-82B3-BA8D0855BB65" style="">Multiprotocol (BLE+ZIGBEE) Concurrent Application - Tutorial</h1><div class="body"><p class="p">This tutorial will help users to create multiprotocol (BLE+ZIGBEE) example project using Mplab code configurator. The step by step procedure will help the user to generate the multiprotocol project from scratch and will guide in understanding few API calls needed for data transaction between 2 protocols.</p>
<p class="p">The project created at end of this tutorial, will look the sample project available here .</p>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__HARDWARE-REQUIRED"><h2 class="title sectiontitle">Hardware Required</h2>
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-E0402AE1-10FD-4FE8-8E32-055F9342F535" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d39492e26"><span> <strong class="ph b">Tool</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d39492e30"><span> <strong class="ph b">Qty</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e26 "><span><span class="ph">WBZ451</span> Curiosity Board</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e30 "><span>2</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e26 "><span>Micro USB cable</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e30 "><span>2</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e26 "><span>Android/iOS Mobile</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e30 "><span>1</span></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__SDK-SETUP"><h2 class="title sectiontitle">SDK Setup</h2><p class="p"> <a class="xref" href="GUID-2AD37FE2-1915-4E34-9A05-79E3810726D7.html" title="Steps to install IDE, compiler, tool chain, BLE, Zigbee stacks and application examples on your PC">SDK Setup</a></p>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__SOFTWARE"><h2 class="title sectiontitle">Software</h2><p class="p"> <a class="xref" href="https://ttssh2.osdn.jp/index.html.en" target="_blank">TeraTerm</a></p>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__SMARTPHONE-APP"><h2 class="title sectiontitle">Smartphone App</h2><p class="p">Microchip Bluetooth Data (MBD) iOS/Android app available in stores</p>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__DEMO-DESCRIPTION"><h2 class="title sectiontitle">Demo Description</h2><p class="p">This application demonstrate the Zigbee On/Off light joining to Zigbee gateway (Combined Interface) and the Microchip Proprietary Transparent Service based BLE peripheral running concurrently with zigbee protocol connects with mobile app. When the Zigbee light gets the light on/off command from CI will be displayed in mobile app. Hence the simple concurrent operation of multiprotocol is demonstrated here. Lights and Bridge (CI) devices are the interest of this tutorial, where the WIFI/Ethernet gateway is not scope of this application. The third party gateway like Amazon Echo plus can also be used instead of CI.</p>
<br /><img class="image" src="GUID-F77964E0-46D6-44BD-A53F-9A31892870FF-low.png" /><br /></div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__DEVELOPING-THIS-APPLICATION-FROM-SCRATCH-USING-MPLAB-CODE-CONFIGURATOR"><h2 class="title sectiontitle">Developing this Application from scratch using MPLab Code Configurator</h2><p class="p">The following steps will help to understand the <span class="ph">PIC32CXBZ2</span> device ZIGBEE and BLE stack programming structure. We recommend to follow the steps. If wish to have Out-of-Box experience with the precompiled hex file Go Here</p>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__PULL-IN-H3-COMPONENTS"><h2 class="title sectiontitle">Pull-in MCC Components</h2><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-AEE0CF5D-9E47-43E7-9A41-CB0CD9FE51C7"><p class="p">Create a new MPLAB Code Configurator Project -- <a class="xref" href="GUID-B86E8493-D00D-46EF-8624-D412342147F0.html">link</a> for instructions</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-13FC328C-DFCD-4806-9B70-984EFE9906A4"><p class="p">Drag and Drop the Zigbee components from "Available" components to Project Graph</p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-0823CFC6-326A-4688-8515-44298ABDCAF9"><p class="p">OnOffLight Device component</p>
</li>
</ul>
<p class="p">"Accept Dependencies or satisfiers, select "Yes""</p>
</li>
</ul>
<img class="image" src="GUID-CB3F5A27-899A-4DAE-A20B-D6BA0256C1B9-low.png" /><img class="image" src="GUID-2587431C-3EBD-4357-A62B-DCF7830F17B7-low.png" /><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-640ADB8F-85CC-4D40-99C9-CDD69107E2F5"><p class="p">Drag and Drop the BLE components</p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-C8A065DC-87F0-4282-9983-3783B31E375A"><p class="p">BLE Stack component</p>
</li>
</ul>
</li>
</ul>
<img class="image" src="GUID-48BA10E0-BF46-4A57-8480-FE142E46B008-low.png" /><pre class="pre codeblock"><code id="d39492e121" content="- Transparent Profile and Service components&#xA;&#xA; &#34;Add  Dependencies or satisfiers&#34;&#xA;">- Transparent Profile and Service components

 "Add  Dependencies or satisfiers"
</code></pre><img class="image" src="GUID-5261D052-7132-438C-AFCE-2D17D513C50A-low.png" /><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-B93FBDEA-0BE8-4402-B8BD-04B6D08B56AB"><p class="p">Add UART components needed for console logs</p>
</li>
</ul>
<img class="image" src="GUID-F6F71066-F292-449D-B24D-6CA7F564F23C-low.png" /><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-A15664F4-3B37-46FB-82F9-3A01357C90AF"><p class="p">Verify the Project Graph window has all the expected components</p>
</li>
</ul>
<img class="image" src="GUID-C1BAE3D2-CBAA-4DD7-BDD4-B1B2BC6C6F4B-low.png" /></div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__EDIT-BLE-STACK-SPECIFIC-CONFIGURATIONS"><h2 class="title sectiontitle">Edit BLE Stack Specific Configurations</h2><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-D81B883F-70A8-4E55-AE03-5EAD10D65EE5"><p class="p">Select <strong class="ph b">BLE_Stack</strong> component in project graph and edit as below</p>
</li>
</ul>
<img class="image" src="GUID-88003D8C-9FD2-4374-BBCB-4E71D38D6858-low.png" /><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-C4564168-6194-4EA0-B035-816CCA781973"><p class="p">Select <strong class="ph b">Transparent Profile</strong> component in project graph and edit as below.</p>
</li>
</ul>
<img class="image" src="GUID-D6120FDC-F032-4877-9CA9-6999E37400F4-low.png" /></div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__EDIT-ZIGBEE-STACK-SPECIFIC-CONFIGURATIONS"><h2 class="title sectiontitle">Edit Zigbee Stack Specific Configurations</h2><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-8C4635F1-D166-4A28-B79E-E76897A61A2B"><p class="p">Edit <strong class="ph b">Onoff Light</strong> component in project graph. The "Commissioning Configuration" is edited to enable only Steering option</p>
</li>
</ul>
<img class="image" src="GUID-FA281534-F32F-4C5A-A830-C86515D46BAC-low.png" /></div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__EDIT-PERIPHERAL-SPECIFIC-CONFIGURATIONS"><h2 class="title sectiontitle">Edit Peripheral Specific Configurations</h2><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-2E06101B-7744-4A69-8D45-C79A1BC6EFA3"><p class="p">Edit <strong class="ph b">SERCOM0</strong> component in project graph for UART pin map and Baud rate</p>
</li>
</ul>
<img class="image" src="GUID-0F04E2D6-4678-4F4B-A699-8F7B624D138F-low.png" /><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-24EBA8D0-B75B-42B7-A526-4AE5D96986D8"><p class="p">Edit <strong class="ph b">Pin Configuration</strong> in project graph for RED LED GPIO configuration</p>
</li>
</ul>
<img class="image" src="GUID-7E100586-3D75-4457-B641-419F4615C978-low.png" /></div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GENERATE-CODE-LINK-FOR-INSTRUCTIONS"><h2 class="title sectiontitle">Generate Code link for instructions</h2></div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__FILES-AND-ROUTINES-AUTOMATICALLY-GENERATED-BY-THE-MHC"><h2 class="title sectiontitle">Files and Routines Automatically generated by the MCC</h2><p class="p">After generating the code from MCC interface by clicking Generate Code, below is the project folder structure.</p>
<img class="image" src="GUID-76411F1D-A6F2-4BFE-90BD-CAF1E6079E60-low.png" /><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-D64C5FF7-61C9-4921-B710-2C5E1ABCF889"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-CF5CFFE1-4CA7-40AA-9B6D-344EBE4D4830"><span class="indent-level-default">1.</span><p class="p">BLE, Zigbee Stack Initialization and Application callback registration:</p>
</li>
</ol>
<p class="p">The RF System, BLE System, ZIGBEE, PERIPHERAL initialization routine executed during program initialization can be found in <strong class="ph b">SYS_Initialize()</strong> of <strong class="ph b">initialization.c</strong> file</p>
<p class="p">Zigbee Stack provides various APIs for application, and those APIs belong to the specific module within dedicated group. The sequence of initialization is already taken care in the stack when <strong class="ph b">Zigbee_Init()</strong> from <strong class="ph b">initialization.c</strong> is called.</p>
<img class="image" src="GUID-0A8E8C62-2382-47AE-B683-8CC6BAA6C8E4-low.png" /><p class="p">The BLE stack initialization routine executed during Application Initialization can be found in <strong class="ph b">APP_BleStackInit()</strong> in <strong class="ph b">app.c</strong>. This call initializes and configures different BLE layers like GAP, GATT, SMP, L2CAP and BLE middleware layers and registers the application layer callbacks. The event callbacks from BLE stack, BLE middleware and Profile/service layer are registered.</p>
<p class="p">Also, the MCC configured advertisement data payload can be seen in <strong class="ph b">APP_BleConfigBasic()</strong></p>
<img class="image" src="GUID-4582B1DA-1C58-4F46-8B23-DB7E963CEEBC-low.png" /><p class="p">Similar to BLE, Zigbee Stack also generate events to inform application if there is any status changed or activity. Application may need to get the relevant information from Zigbee Stack and do the corresponding procedure.</p>
<img class="image" src="GUID-22BCB827-B425-421F-AAA0-888251A17B38-low.png" /><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-FC5ADF35-A751-4769-B32C-4DB61DF1FF93"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-E7BEA253-62F3-45AD-A2E9-9EE41DC74059"><span class="indent-level-default">1.</span><p class="p">BLE, Zigbee Stack application events handling: <strong class="ph b">app.c</strong> file is autogenerated and has a state machine for application callback handling from BLE, Zigbee stacks</p>
</li>
</ol>
<img class="image" src="GUID-7FB8A493-0D28-4A38-B972-12F181ACC370-low.png" /></div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__USER-APPLICATION-DEVELOPMENT"><h2 class="title sectiontitle">User Application Development</h2><p class="p"><strong class="ph b">1. Compile MCC auto generated project</strong></p>
<ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-A0083FB0-BA23-412A-8B72-1BFB3557AA28"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-60A67517-783A-4AE9-95BD-C58D6FE0AB69"><span class="indent-level-default">1.</span><p class="p">Compile the MCC auto generated project as below</p>
</li>
</ol>
<br /><img class="image" src="GUID-56046397-1FDA-421E-8264-85EA0AFDBF5C-low.png" /><br /><img class="image" src="GUID-624BC4FE-BA09-4D26-B4C5-DAB4DA44E793-low.png" /><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-36E20D52-DFEB-43EC-9BD4-C78DFFD4F542"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-1E7D6E33-EA14-4AB3-B3DD-43D2BCBBD45B"><span class="indent-level-default">1.</span><p class="p">Addressing the mandatory error: User action required in app_idle_task.c. Follow the steps mentioned in the note and do the necessary changes. Then comment the <strong class="ph b">#error</strong> message as below.</p>
</li>
</ol>
<img class="image" src="GUID-5B0478C1-3575-448F-838E-4FDFFBA414B5-low.png" /><p class="p"><strong class="ph b">2. BLE specific code addition</strong></p>
<p class="p"><strong class="ph b">1. Start Advertisement (app.c)</strong></p>
<p class="p">Advertisement payload is already auto generated based on MCC configuration as mentioned in Edit BLE Stack Specific Configurations. It is only required to start the advertisement, by adding the below API in APP_STATE_INIT state.</p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-F5FCE77E-BA3C-4C95-B2D6-2B9F6AA07A38"><p class="p">BLE_GAP_SetAdvEnable(true, 0);</p>
</li>
</ul>
<pre class="pre codeblock json">void APP_Tasks ( void )
{
    APP_Msg_T    appMsg[<span class="hl-number">1</span>];
    APP_Msg_T   *p_appMsg;
    p_appMsg=appMsg;

    ZB_AppGenericCallbackParam_t cb;
    <em class="hl-comment">/* Check the application's current state. */</em>
    switch ( appData.state )
    {
        <em class="hl-comment">/* Application's initial state. */</em>
        case APP_STATE_INIT:
        {
            bool appInitialized = true;
            <em class="hl-comment">//appData.appQueue = xQueueCreate( 10, sizeof(APP_Msg_T) );</em>
            APP_BleStackInit();
            BLE_GAP_SetAdvEnable(true, <span class="hl-number">0</span>);</pre><p class="p"><strong class="ph b">2. Connected &amp; Disconnected Events (app_ble_handler.c)</strong></p>
<p class="p">The BLE application specific callbacks from BLE stack is handled in <strong class="ph b">app_ble_handler.c</strong> file. Few events needed for this application to be handled by the user code as below.</p>
<p class="p"><strong class="ph b">Connection Handler</strong></p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-9ED43873-987E-48D0-87D4-7C44150C7863"><p class="p">In <strong class="ph b">app_ble_handler.c</strong>, BLE_GAP_EVT_CONNECTED event will be generated when a BLE peripheral is connected with Central (mobile app)</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-CA6EF885-EB50-469E-B13B-BE08662B616E"><p class="p">Connection handle associated with the peer central device needs to be saved for data exchange after a BLE connection. Add the below code in <strong class="ph b">APP_BleGapEvtHandler()</strong>.</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-BA2698C8-04CA-4171-A2E4-621D9C94A59C"><p class="p">Console log is also added to print the connected message and respective #include file is also added.</p>
</li>
</ul>
<pre class="pre codeblock json">#include &lt;app_zigbee/zigbee_console/console.h&gt;

void APP_BleGapEvtHandler(BLE_GAP_Event_T *p_event)
{
    switch(p_event-&gt;eventId)
    {
        case BLE_GAP_EVT_CONNECTED:
        {
            <em class="hl-comment">/* TODO: implement your application code.*/</em>
            appSnprintf(<span class="hl-string">"[BLE} Connected\n\r"</span>);
            conn_hdl = p_event-&gt;eventField.evtConnect.connHandle;
            linkState = APP_BLE_STATE_CONNECTED;
        }
        break;</pre><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-C2F78A73-7866-4654-AFB4-FE619AD5C454"><p class="p">In <strong class="ph b">app_ble_handler.h</strong> add the below definitions which are used in above step</p>
</li>
</ul>
<pre class="pre codeblock json"><em class="hl-comment">// *****************************************************************************</em>
<em class="hl-comment">// *****************************************************************************</em>
<em class="hl-comment">// Section: Type Definitions</em>
<em class="hl-comment">// *****************************************************************************</em>
<em class="hl-comment">// *****************************************************************************</em>
uint16_t conn_hdl;
uint8_t linkState;

#define APP_BLE_STATE_CONNECTED <span class="hl-number">0x01</span>
#define APP_BLE_STATE_STANDBY  <span class="hl-number">0x00</span></pre><p class="p"><strong class="ph b">Disconnection Handler</strong></p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-A0309B50-CF92-4407-8FB4-0BC55FD7A014"><p class="p">In <strong class="ph b">app_ble_handler.c</strong>, BLE_GAP_EVT_DISCONNECTED event will be generated when BLE peripheral is disconnected from Central (mobile app)</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-4C26B41F-C8C6-4D21-AF1A-5D8DEDA769ED"><p class="p">Advertisement can be started again to enable another connection</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-6B80AAB9-D80B-4859-8A46-A6C4BFC1F9FF"><p class="p">Console log is also added to print the disconnected message</p>
</li>
</ul>
<pre class="pre codeblock json">case BLE_GAP_EVT_DISCONNECTED:
{
    <em class="hl-comment">/* TODO: implement your application code.*/</em>
    appSnprintf(<span class="hl-string">"[BLE} DisConnected\n\r"</span>);
    BLE_GAP_SetAdvEnable(true, <span class="hl-number">0</span>);
    linkState = APP_BLE_STATE_STANDBY;               
}
break;</pre><p class="p"><strong class="ph b">3. Zigbee specific code addition (app_zigbee_handler.c)</strong></p>
<p class="p">There will be 3 major events which the stack would provide to the user application in <strong class="ph b">app_zigbee_handler.c</strong> file. They are ,</p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-ED88ED94-0CF1-4FBF-95B6-A43125D89E60"><p class="p">Zigbee Events which is defined as "EVENT_ZIGBEE"</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-CB329CF3-6A1B-41B9-B3DA-4609278C37C7"><p class="p">ZCL and Cluster Events defined as "EVENT_CLUSTER"</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-59ACB48D-0001-4362-8D6D-35B20BBB7168"><p class="p">Board Specific Package (BSP) Events defined as "EVENT_BSP"</p>
</li>
</ul>
<p class="p"><strong class="ph b">1. ZCL EVENT_CLUSTER event handling for on/off Light cluster</strong></p>
<p class="p"> <strong class="ph b">ZCL (Zigbee cluster library)</strong></p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-B91FA471-D1F0-4BC7-89C1-C065AEA060ED"><p class="p">ZCL is a repository for cluster functionalities</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-5249A33F-0171-46F3-A678-67DB0F674462"><p class="p">Regularly updated with new functionality added</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-A55B4679-1525-4DBF-8D4C-DC1C9CE9305E"><p class="p">Not to “re-invent the wheel” for new application development</p>
</li>
</ul>
<p class="p"> <strong class="ph b">Cluster</strong></p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-C53A6D88-AFEB-433B-9DAE-BC6543621FEF"><p class="p">Cluster is a set of attributes and commands which are defined for a particular application functionality/feature.</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-A1F70403-3BFB-414F-A2BF-8C2AE90CC520"><p class="p">Attributes and their data types are defined</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-EAFB96ED-BB4D-4E41-B58D-3F0353E34CDC"><p class="p">Uses client/server model of communication</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-EE291F03-02D1-47D9-9C90-2BB3AEF6CCE7"><p class="p">Standard commands/messages ensure interoperability, abstracts the commands for developers.</p>
</li>
</ul>
<p class="p"><strong class="ph b">Ex: On/Off cluster</strong> Attributes: OnOff, OnTime, OffWaitTime Commands: Off, On, Toggle, OffWithEffect, OnWithRecallGlobalScene, OnWithTimedOff</p>
 <span class="ph icon icon-search inline-block highlight-info"> <em class="ph i">-Explore</em> </span><p class="p">For more details regarding clusters, please refer to, the specification from Zigbee Alliance -&gt; <a class="xref" href="https://zigbeealliance.org/wp-content/uploads/2019/12/07-5123-06-zigbee-cluster-library-specification.pdf" target="_blank">Link to Zigbee Cluster Library Specification by Zigbee Alliance</a></p>
<p class="p">This project uses On/Off device type. Hence uses <strong class="ph b">On/Off light cluster</strong> from Zigbee defined cluster library. When the On/Off command to control the light is received from Combined Interface gateway, CMD_ZCL_ON, CMD_ZCL_OFF of ZCL EVENT_CLUSTER will be received on light device. A simple console print is already added in those event callbacks as below.</p>
<pre class="pre codeblock json">void Cluster_Event_Handler(APP_Zigbee_Event_t event)
{
    switch(event.eventId)
    {
        case CMD_ZCL_ON:
        {
            <em class="hl-comment">/* ZCL Command ON received */</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.addressing;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payloadLength;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payload;</em>
            appSnprintf(<span class="hl-string">"On\r\n"</span>);
            uint8_t onCmd;
            onCmd = <span class="hl-number">0x01</span>;
            
            if(linkState == APP_BLE_STATE_CONNECTED)
                BLE_TRSPS_SendVendorCommand(conn_hdl, <span class="hl-number">0x8F</span>, <span class="hl-number">0x01</span>, &amp;onCmd);            
        }
        break;
        case CMD_ZCL_OFF:
        {
            <em class="hl-comment">/* ZCL Command Off received */</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.addressing;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payloadLength;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payload;</em>
            appSnprintf(<span class="hl-string">"Off\r\n"</span>);
            uint8_t offCmd;
            offCmd = <span class="hl-number">0x00</span>;
            
            if(linkState == APP_BLE_STATE_CONNECTED)
                BLE_TRSPS_SendVendorCommand(conn_hdl, <span class="hl-number">0x8F</span>, <span class="hl-number">0x01</span>, &amp;offCmd);             
        }
        break;</pre><p class="p"><strong class="ph b">2. EVENT_BSP event handling for on/off Light control</strong></p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-0BFADC1A-6FE4-4149-B55A-18C514F4D3ED"><p class="p">In addition to above ZCL event, BSP event will also be called when On/Off command is received. This will enable the user to write the board specific functionality code like switch on/off the on board LED. <strong class="ph b">CMD_LED_BRIGHTNESS</strong> single event is called for both On or Off, since On/Off cluster is added in many other device types like dimmable light, color control light, where light functionality is also mapped to brightness/color and not simple On/Off. Add below code to control on board <strong class="ph b">RED</strong> LED.</p>
</li>
</ul>
<pre class="pre codeblock json">void BSP_Event_Handler(APP_Zigbee_Event_t event)
{
    <em class="hl-comment">// User to handle  board Support package events</em>
    switch(event.eventId)
    {
        case CMD_LED_BRIGHTNESS:
        {
            <em class="hl-comment">/* Set the given LED brightness */</em>
            <em class="hl-comment">//Access - &gt; event.eventData.value;</em>
            <em class="hl-comment">//appSnprintf("Led Brightness \r\n");</em>
            if(event.eventData.value == <span class="hl-number">255</span>)<em class="hl-comment">// MAX_BRIGHTNESS_LEVEL for On</em>
               RED_LED_Set();
            else if (event.eventData.value == <span class="hl-number">0</span>) <em class="hl-comment">//MIN_BRIGHTNESS_LEVEL for Off</em>
               RED_LED_Clear();
                
        }
        break;</pre><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-13CA5601-FD99-4015-850A-85A26CD81851"><p class="p">Add the include file needed for LED GPIO functionality in <strong class="ph b">app_zigbee_handler.c</strong></p>
</li>
</ul>
<pre class="pre codeblock json">#include <span class="hl-string">"peripheral/gpio/plib_gpio.h"</span></pre><p class="p"><strong class="ph b">3. Edit device unique ID (zigbeeAppDeviceSelect.h)</strong></p>
<p class="p">All the zigbee devices/modules will hold their unique IEEE address purchased from IEEE. For the demo purpose, where UID is not present in internal NVM, the pre-compiled fixed UID to be used. Edit the CS_UID to user defined value and not matching with combined interface UID (default 0xbee) as below in <strong class="ph b">zigbeeAppDeviceSelect.h</strong></p>
<p class="p"><img class="image" height="500" src="GUID-B142CF1F-4D82-47B8-B9F6-69C68958F0D4-low.png" width="500" /></p>
<p class="p"><strong class="ph b">4. Data Transaction between BLE to ZIGBEE protocol and vice versa</strong></p>
<p class="p">Transparent Profile and Service (TRP/TRS) is the proprietary BLE service by microchip to establish data and control channel between BLE Central (Phone) and Peripheral (device). The custom 128-bit GATT characteristics are defined under this service.</p>
<p class="p"> <strong class="ph b">Definition of Transparent Service and Characteristics UUID's</strong></p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-51677772-4EC3-45C7-AE0C-AE67E67AE426" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d39492e456"><span>Characteristic Name</span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d39492e458"><span>UUID</span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d39492e460"><span>Properties</span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e456 "><span>TRS Service</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e458 "><span>49535343-FE7D-4AE5-8FA9-9FAFD205E455</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e460 "><span> </span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e456 "><span>TRS TxD- Tx Data to Client role (Data pipe)</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e458 "><span>49535343-1E4D-4BD9-BA61-23C647249616</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e460 "><span>Notify, Write</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e456 "><span>TRS TxD - Client Characteristic Configuration Descriptor</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e458 "><span> </span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e460 "><span>Read, Write</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e456 "><span>TRS RxD- Rx Data from Client role (Data pipe)</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e458 "><span>49535343-8841-43F4-A8D4-ECBE34729BB3</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e460 "><span>Write, Write without response</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e456 "><span>TRS Ctrl Pt - Command and Response (Ctrl pipe)</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e458 "><span>49535343-4C8A-39B3-2F49-511CFF073B7E</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e460 "><span>Notify, Write, Write without response</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e456 "><span>TRS Ctrl Pt - Client Characteristic Configuration descriptor</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e458 "><span> </span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d39492e460 "><span>Read, Write</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p"><strong class="ph b">1. Send data over BLE (app_zigbee_handler.c)</strong></p>
<p class="p">When the On/Off command is received from CI, send single byte of data to mobile app using Transparent service. We use TRS Ctrl Pt characteristic in this example project to send and receive data from mobile app.</p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-E4452AAC-C9D3-4245-89AD-E8B51B4375B1"><p class="p"><strong class="ph b">BLE_TRSPS_SendVendorCommand(conn_hdl, 0x8F, 0x01, &amp;onCmd)</strong> is the API to be used for sending data towards the central device. Here 0x8F is any custom command value for identification and 0x01 is length of the command data. Add this API call in Zigbee On/Off ZCL event callbacks as below.</p>
</li>
</ul>
<pre class="pre codeblock json">void Cluster_Event_Handler(APP_Zigbee_Event_t event)
{
    switch(event.eventId)
    {
        case CMD_ZCL_ON:
        {
            <em class="hl-comment">/* ZCL Command ON received */</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.addressing;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payloadLength;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payload;</em>
            appSnprintf(<span class="hl-string">"On\r\n"</span>);
            uint8_t onCmd;
            onCmd = <span class="hl-number">0x01</span>;

            if(linkState == APP_BLE_STATE_CONNECTED)
                BLE_TRSPS_SendVendorCommand(conn_hdl, <span class="hl-number">0x8F</span>, <span class="hl-number">0x01</span>, &amp;onCmd);            
        }
        break;
        case CMD_ZCL_OFF:
        {
            <em class="hl-comment">/* ZCL Command Off received */</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.addressing;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payloadLength;</em>
            <em class="hl-comment">//Access - &gt; event.eventData.zclEventData.payload;</em>
            appSnprintf(<span class="hl-string">"Off\r\n"</span>);
            uint8_t offCmd;
            offCmd = <span class="hl-number">0x00</span>;

            if(linkState == APP_BLE_STATE_CONNECTED)
                BLE_TRSPS_SendVendorCommand(conn_hdl, <span class="hl-number">0x8F</span>, <span class="hl-number">0x01</span>, &amp;offCmd);             
        }
        break;</pre><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-2CC195B1-1226-43C8-A77F-4B5FCA698F38"><p class="p">Add the include file needed for the above BLE API's in <strong class="ph b">app_zigbee_handler.c</strong></p>
</li>
</ul>
<pre class="pre codeblock json">#include <span class="hl-string">"app_ble_handler.h"</span>
#include <span class="hl-string">"ble/profile_ble/ble_trsps/ble_trsps.h"</span></pre><p class="p"><strong class="ph b">2. Send data over ZIGBEE (app_trsps_handler.c)</strong></p>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-B04867A7-8809-4645-8FA0-4CFC70D3D2D0"><p class="p">When the On/Off single byte data is received from mobile app using Transparent service, change the global variable which holds the On/Off attribute value.</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-538F64AC-0E31-461F-818B-18ACA8AEEFCF"><p class="p">On/Off attribute data is sent periodically at defined MAX interval to CI. When the On/Off attribute value is changed by BLE, an additional report will be sent at MIN report interval with the changed value. The reporting interval is configured in auto generated Zigbee middleware include file <strong class="ph b"> firmware\src\config\default\zigbee\z3device\light\include\lightOnOffCluster.h</strong> (unit in seconds)</p>
</li>
</ul>
<pre class="pre codeblock json"><em class="hl-comment">/******************************************************************************
                    Definition(s) section
******************************************************************************/</em>
#define ONOFF_VAL_MIN_REPORT_PERIOD <span class="hl-number">30</span>
#define ONOFF_VAL_MAX_REPORT_PERIOD <span class="hl-number">120</span></pre><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-7CFF2C9A-FD82-4076-A96C-6C1D379F6CAF"><p class="p">When the non zero value is sent from mobile app using TRPS Ctrl pt characteristic, the LED is switched ON and for zero value LED is switched OFF in BLE_TRSPS_EVT_VENDOR_CMD event callback. Add the below code to update the On/Off attribute Value and to change <strong class="ph b">RED LED</strong> Status. <strong class="ph b">ZCL_ReportOnChangeIfNeeded()</strong> API is called to initiate the additional report at <strong class="ph b">ONOFF_VAL_MIN_REPORT_PERIOD</strong> interval. <strong class="ph b">lightOnOffClusterServerAttributes.onOff</strong> is the global variable defined in Zigbee middleware which holds the OnOFF attribute value.</p>
</li>
</ul>
<pre class="pre codeblock json">void APP_TrspsEvtHandler(BLE_TRSPS_Event_T *p_event)
{
    switch(p_event-&gt;eventId)
    {
        case BLE_TRSPS_EVT_VENDOR_CMD:
        {
            <em class="hl-comment">/* TODO: implement your application code.*/</em>
            if(p_event-&gt;eventField.onVendorCmd.length)
            {                 
                if(p_event-&gt;eventField.onVendorCmd.p_payLoad[<span class="hl-number">1</span>])
                {    
                    lightOnOffClusterServerAttributes.onOff.value = <span class="hl-number">1</span>;
                    RED_LED_Set();
                    appSnprintf(<span class="hl-string">"[BLE} On Command\n\r"</span>);                    
                }    
                else
                {    
                    lightOnOffClusterServerAttributes.onOff.value = <span class="hl-number">0</span>;
                    RED_LED_Clear();
                    appSnprintf(<span class="hl-string">"[BLE} Off Command\n\r"</span>);                    
                }                   
                ZCL_ReportOnChangeIfNeeded(&amp;lightOnOffClusterServerAttributes.onOff);
            }    
        }
        break;</pre><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-EC0801BE-E352-4F7E-8731-93A16D1DBFEF"><p class="p">Add the include file needed for the above ZIGBEE API and GPIO in <strong class="ph b">app_trsps_handler.c</strong></p>
</li>
</ul>
<pre class="pre codeblock json">#include &lt;app_zigbee/zigbee_console/console.h&gt;
#include &lt;z3device/light/include/lightOnOffCluster.h&gt;
#include <span class="hl-string">"peripheral/gpio/plib_gpio.h"</span></pre><p class="p"><strong class="ph b">Note:</strong> The sample project with all the above code changes is available in ble_zigbee_basic for your reference.</p>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__PROGRAMMING-THE-APPLICATION-USING-MPLABX-IDE"><h2 class="title sectiontitle">Programming the Application using MPLABX IDE</h2><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-32338F67-60EA-4B5D-8AD5-5768B3DECD50"><p class="p">Build the project after doing all the above changes and program on Curiosity board</p>
</li>
</ul>
<br /><img class="image" src="GUID-000923CE-F0D6-4DDB-BBF3-A895F4DCF52B-low.png" /><br /><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-3714BEB7-8EE4-4FA4-9426-8E51B3D6A85F"><p class="p">Program the combined interface hex image on another curiosity board for Zigbee gateway by following below steps.</p>
</li>
</ul>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__PROGRAMMING-THE-PRECOMPILED-HEX-FILE-USING-MPLABX-IPE"><h2 class="title sectiontitle">Programming the precompiled hex file using MPLABX IPE</h2><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-4616F54A-6B91-4119-A893-CDEE0C6E8591"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-FD39FA31-5ECF-413F-9592-22CE2F8E0367"><span class="indent-level-default">1.</span><p class="p">Precompiled Hex file is located here </p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-EBD70409-5C2B-4E76-9C3B-F2064A02AC14"><span class="indent-level-default">2.</span><p class="p">Follow the steps mentioned <a class="xref" href="https://microchipdeveloper.com/ipe/programming-device" target="_blank">here</a></p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-057E49C4-2465-46AB-B772-72B1A8848AAB"><span class="indent-level-default">3.</span><p class="p">Program the combined interface hex image on another curiosity board for Zigbee gateway by following same procedure.</p>
</li>
</ol>
<p class="p"><strong class="ph b">Caution:</strong> Users should choose the correct Device and Tool information</p>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__TESTING"><h2 class="title sectiontitle">Testing</h2><p class="p">This section assumes that user has already programmed multiprotocol Application Example and combined interface example on 2 <span class="ph">WBZ451</span> Curiosity boards</p>
<p class="p"> <strong class="ph b">Demo Experience when using a Smartphone (MBD App) as Central Device</strong></p>
<ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-67387698-0DAC-4F78-AB40-D987EF9F0443"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-4A512892-812B-4A04-8A11-9C9862FC52A1"><span class="indent-level-default">1.</span><p class="p">Reset the Combined Interface programmed <span class="ph">WBZ451</span> Curiosity board, Open Terminal emulator like Tera Term, select the right COM port@ (Speed: 115200, Data: 8-bit, Parity: none, stop bits: 1 bit, Flow control: none, enable CR+LF for RX, TX in Terminal setup).</p>
</li>
<li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-5D313BD0-56CE-415F-A09A-8D243B336E09"><span class="indent-level-default">2.</span><p class="p">send command: <em class="ph i">resetToFN</em> and look for the below logs for successful zigbee network formation on CI</p>
</li>
</ol>
<img class="image" src="GUID-360B7F34-1018-453C-AEA6-71322B1E9964-low.png" /><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-9625C325-4013-4025-91E3-DA7BD71B0C32"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-6B9A06E9-AF64-4DCA-9E8D-1F9FBA04F8F3"><span class="indent-level-default">1.</span><p class="p">Reset combo device and send command: <em class="ph i">resetToFN</em>. Look for combo device joined with combined Interface. The on/off light cluster search and binding between 2 devices is successful, and combo device on/off light attributes reports are seen in CI. This would take about 180sec.</p>
</li>
</ol>
<img class="image" src="GUID-DA8D1C48-C80B-4243-84EE-09228ABC3707-low.png" /><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-0647FACE-1FDA-42B6-A527-5FCDF67CE650"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-D63F1ABB-7AAF-4142-BC2B-E6CE5506726E"><span class="indent-level-default">1.</span><p class="p">Open Microchip Bluetooth Data (MBD) App on your smartphone, Search and select the advertisement with Device Name "Combo". Connect with the combo device.</p>
</li>
</ol>
<img class="image" src="GUID-CB281E14-1E55-4AF7-A44B-C9CB76040CBB-low.gif" /><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-A47BBDB0-F3DF-4772-816D-9005DEB510CC"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-E7AF6E82-5A3E-4A6B-87DA-643F734E73BE"><span class="indent-level-default">1.</span><p class="p">Enable Notify/Indicate to receive data from combo device</p>
</li>
</ol>
<p class="p"><img class="image" height="500" src="GUID-DF37D8AF-CA64-4607-A28D-E28CA2C12D29-low.jpg" width="250" /></p>
<ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-B5DCFE88-12A7-405D-A1FD-E818D1BA2C25"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-7DECBD8E-CC7E-4B12-9363-7CE67F236275"><span class="indent-level-default">1.</span><p class="p">Write <strong class="ph b">8F01</strong> to switch on RED LED and look for on/off attribute value changing to 0x01 in CI, and also RED LED is getting ON. Similarly write *<em class="ph i">8F00</em> to switch off RED LED and look for attribute value changing to 0x00 in CI. As mentioned previously, it would take MIN report interval for the changed report value to appear in CI.</p>
</li>
</ol>
<p class="p"><img class="image" height="500" src="GUID-70758EE6-1C91-4F94-834A-7FDF355E81C0-low.jpg" width="250" /></p>
<img class="image" height="500" src="GUID-1F21CC4C-F500-4724-8131-61D86E190F3A-low.jpg" width="250" /><p class="p"></p>
<img class="image" src="GUID-FBEB61ED-4A19-49A5-B0C4-129DF718F83C-low.png" /><ol class="ol" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-D868AB55-67E1-463F-BD9E-86502B9919F7"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-0C17E693-EEC7-4B71-81F9-E8AD81F5F67E"><span class="indent-level-default">1.</span><p class="p">By sending on/off command from CI the RED LED can be switched On/Off. The value can be seen in MBD app as well.</p>
</li>
</ol>
<ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-446B9DDD-2F1F-40E9-A23C-49C322024CEE"><p class="p">The network address of the combo device is needed to send light control commands to combo device from CI. This network address can be got from Combined interface console log while joining was done.</p>
</li>
</ul>
<img class="image" src="GUID-65728CD9-F2E5-4834-B7C7-272FE4B9BC4D-low.png" /><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-EC342EBB-EC15-4BB3-AEA5-28A24B4A281A"><p class="p">Another way to get the network address from combo device is executing the below command in combo light side.</p>
</li>
</ul>
<pre class="pre codeblock json">        Command: getNetworkAddress
        Response: <span class="hl-number">9</span>bfa</pre><pre class="pre codeblock json">On/off command:
           onOff <span class="hl-number">0x0</span> <span class="hl-number">0x9bfa</span> <span class="hl-number">0x20</span> -on

           onOff <span class="hl-number">0x0</span> <span class="hl-number">0x9bfa</span> <span class="hl-number">0x20</span> -off</pre><pre class="pre codeblock"><code id="d39492e680" content="  0x20 is zigbee end point number used for light can be taken from MCC configurator.&#xA;">  0x20 is zigbee end point number used for light can be taken from MCC configurator.
</code></pre><img class="image" src="GUID-1C221F36-FD2B-4982-9ADF-5F62185B62BF-low.png" /><img class="image" src="GUID-FBEB61ED-4A19-49A5-B0C4-129DF718F83C-low.png" /><p class="p"><img class="image" height="500" src="GUID-2B151590-2FFA-49C9-B895-3BFC94E97A0F-low.jpg" width="250" /><img class="image" height="500" src="GUID-1A3A2D12-1BCB-4735-B605-807BB2AA5617-low.jpg" width="250" /></p>
</div>
<div class="section" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__WHERE-TO-GO-FROM-HERE"><h2 class="title sectiontitle">Where to go from here</h2><ul class="ul"><li class="li" id="GUID-11ABDEE6-3F90-4086-AC19-BB2607CA8064__GUID-73EEB446-3909-40DC-A5C4-9FA857F7FAE2"><p class="p"><a class="xref" href="GUID-707BAEEE-0EFF-428F-AFEC-C2E6C5E65BA9.html">Advanced Multiprotocol Application with Zigbee Provisioning over BLE</a> by following the similar implementation. The guide also explains the wrapper protocol written on top of BLE Transparent service for BLE provisioning and light control. The on board RGB colour is controlled in this example, which can be referenced for PWM functionality.</p>
</li>
</ul>
</div>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-2A54CAC1-1370-4448-8768-E6C7B8CFCA23.html" title="Documentation describing steps to test and develop the precompiled BLE and Zigbee coexistence application examples.">Getting Started With Multiprotocol Applications</a></div>
</div>
</div></body>
</html>