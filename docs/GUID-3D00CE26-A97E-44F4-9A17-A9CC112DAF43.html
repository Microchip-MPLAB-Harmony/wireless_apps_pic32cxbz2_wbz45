<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="BLE ZigBee Provisioning Low Power Application Demo: Zigbee Multi-Sensor and Zigbee commissioning through BLE" />
<meta name="DC.relation" scheme="URI" content="GUID-2A54CAC1-1370-4448-8768-E6C7B8CFCA23.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43" />
<meta name="DC.language" content="en-US" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>BLE ZigBee Provisioning Low Power Application Demo: Zigbee Multi-Sensor and Zigbee commissioning through BLE</title>
<meta name="Microsoft.Help.Id" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43" />
<meta name="Microsoft.Help.TocParent" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-2A54CAC1-1370-4448-8768-E6C7B8CFCA23" />
<meta name="Microsoft.Help.TocOrder" content="4" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="Software Development Reference A 09/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43">
<h1 class="title topictitle1" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-DEE7421E-6B70-4D15-B0BD-4D876E92361A" style="">BLE ZigBee Provisioning Low Power Application Demo: Zigbee Multi-Sensor and Zigbee commissioning through BLE</h1><div class="body"><p class="p">This tutorial will help users to create a low power enabled multiprotocol (BLE+ZIGBEE) example project using Mplab code configurator. The step by step procedure will help the user to generate a Zigbee Multi-Sensor application and commission the Multi-Sensor to a Zigbee network through BLE from scratch.</p>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__HARDWARE-REQUIRED"><h2 class="title sectiontitle">Hardware Required</h2>
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-B6C2E0F1-2E1B-4BDC-B770-1AE56A0976F0" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="vertical-align:middle;" id="d31106e24"><span> <strong class="ph b">Tool</strong></span></th>
<th class="entry cellrowborder" style="vertical-align:middle;" id="d31106e28"><span> <strong class="ph b">Qty</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d31106e24 "><span><span class="ph">WBZ451</span> Curiosity Board</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d31106e28 "><span>1</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d31106e24 "><span>Micro USB cable</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d31106e28 "><span>1</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d31106e24 "><span>Android/iOS Mobile</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;" headers="d31106e28 "><span>1</span></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SDK-SETUP"><h2 class="title sectiontitle">SDK Setup</h2><p class="p"><a class="xref" href="GUID-2AD37FE2-1915-4E34-9A05-79E3810726D7.html" title="Steps to install IDE, compiler, tool chain, BLE, Zigbee stacks and application examples on your PC">Getting Started with Software Development</a></p>
</div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SMARTPHONE-APP"><h2 class="title sectiontitle">Smartphone App</h2><p class="p">Microchip Bluetooth Data (MBD) iOS/Android app available in stores</p>
</div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__DEMO-DESCRIPTION"><h2 class="title sectiontitle">Demo Description</h2><p class="p">This application demonstrate the Zigbee Multi-Sensor end device joining to Zigbee Coordinator (Combined Interface, The thirdparty gateway's like Amazon Echo plus can also be used instead of CI.) by receiving the commissioning parameters from user using a mobile phone through BLE Link. The mobile application uses Microchip Proprietary Transparent Service to send and receive data PIC32CX-BZ2/<span class="ph">WBZ451</span> device.</p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_H4L_HSN_1VB" src="GUID-E015A923-88E2-4B95-9487-69A31EB2AAB5-low.jpg" /><br /></div>
<p class="p">The BLE provisioner in the MBD App (available in Google Play Store and Apple Store) is utilized to demo the provisioning functionality. </p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_XSV_3SN_1VB" src="GUID-94E5FCA3-6EE9-48D2-9787-E67A1D708E76-low.jpg" /><br /></div>
</div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__DEVELOPING-THIS-APPLICATION-FROM-SCRATCH-USING-MPLAB-CODE-CONFIGURATOR"><h2 class="title sectiontitle">Developing this Application from scratch using Mplab Code Configurator</h2><p class="p">The following steps will help to understand the <span class="ph">PIC32CXBZ2</span> device ZIGBEE and BLE stack programming structure. Ensure that wireless_system_pic32cxbz2_wbz45 repo is available locally as documented in <a class="xref" href="GUID-2AD37FE2-1915-4E34-9A05-79E3810726D7.html" title="Steps to install IDE, compiler, tool chain, BLE, Zigbee stacks and application examples on your PC">Getting Started with Software Development</a>. Following are recommended steps.</p>
</div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SECTION_KBG_TTN_1VB"><h2 class="title sectiontitle"><strong class="ph b">Pull-in H3 Components</strong></h2></div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SECTION_LZF_TTN_1VB"><ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_LGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-3A01841C-A542-466E-890A-56008F69AEE0"><p class="p">Create a new MPLAB Code Configurator Project -- <a class="xref" href="GUID-B86E8493-D00D-46EF-8624-D412342147F0.html">link</a> for instructions</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-D090ACCE-B994-4281-81CB-8489FB56CC23"><p class="p">Open MPLABx Code Configurator. The Wireless System Service components will be displayed in available components. Select BLE ZIGBEE PROVISIONING from Device Resouces --&gt; Wireless --&gt;System Services as shown in the below figure.</p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_VYG_BPN_1VB" src="GUID-8773A2B3-6ECA-4BC8-A3CD-6540547C7501-low.png" /><br /></div>
</li>
</ul>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_MGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-7CF3D5EC-954A-4C8C-BA2D-51E6605AE237"><p class="p"> Accept all dependencies by selecting "Yes". Click on the Zigbee Device dependency on the BLE ZIGBEE PROVISIONING, select MultiSensor. The project graph will appear as shown in the figure below. </p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_MF3_WPN_1VB" src="GUID-41A898BD-27B7-4DF9-9344-2F268B39D604-low.png" /><br /></div>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_ULN_HPN_1VB" src="GUID-E8356D9B-DAAB-4BD1-8EF5-0864C4E9D288-low.png" /><br /></div>
</li>
</ul>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_NGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-07C2255A-C900-49B9-BC60-980C95C1CE89"><p class="p">Select the Multi Sensor Zigbee device component by click on the component in the project graph. Now the <em class="ph i">Configuration Options</em> tab will list the Configurations for the selected Zigbee device. Ensure that the <em class="ph i">Manual Configuration</em> is selected and <em class="ph i">Network Formation Commissioning Enable</em> and <em class="ph i">AUTOMATIC COMMISSIONING ON STARTUP</em> is deselected as shown in below figure.</p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_TPJ_MSN_1VB" src="GUID-3F883CDB-BC3B-4D7A-87EF-189A4CEE83BA-low.jpg" /><br /></div>
</li>
</ul>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_OGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-F42EF70C-AD94-43CA-A078-3085E5707ED7"><p class="p">Select the BLE Stack component by clicking on the component. In the Configuration Options tab, Expand Generic Access Profile (GAP) --&gt; Advertising and then expand Advertising Data and Scan Response Data.</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-FCFB5E1B-30A5-4212-9DF4-3AEF34FAD5BE"><p class="p">In <em class="ph i">Advertising Data</em> menu, ensure that <em class="ph i">Local Name</em> is deselected and selected in <em class="ph i">Scan Response Data</em> --&gt; <em class="ph i">Local Name</em>. In <em class="ph i">Advertising Data</em> menu, ensure that <em class="ph i">Service Data</em> is selected, <em class="ph i">Service UUID</em> is selected as 0xFEDA and <em class="ph i">Service Data</em> is set as 0xFF03 as shown in below figure.</p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_B4W_PSN_1VB" src="GUID-5B7E80BA-E686-4014-A0BC-1B1D02F0ABA5-low.jpg" /><br /></div>
</li>
</ul>
<p class="p"><strong class="ph b">Note</strong>:</p>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_PGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-F27B4937-5D2E-40DE-B632-5B064E2D0029"><p class="p">0xFEDA is a 16-bit Service UUID which is purchased by Microchip from Bluetooth SIG.</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-D77D7095-700A-4419-BF4F-B9361D7AA80A"><p class="p">In order to list the device while scanning in Microchip Bluetooth Data (MBD) mobile application, the device should advertise with Service UUID as 0xFEDA and Service Data as 0xFF03.</p>
</li>
</ul>
</div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SECTION_GMB_STN_1VB"><h2 class="title sectiontitle"><strong class="ph b">Low power Configuration</strong></h2></div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SECTION_SJB_STN_1VB"><ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_QGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-5B366EF4-4B73-4515-9F81-3714461FB924"><p class="p">Enable Sleep Mode in BLE stack H3 component configuration, after enabling this dependent component like RTC (Timer source during sleep) will be requested to be enabled</p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_FVH_DQN_1VB" src="GUID-361EDCCF-6E80-4495-AEEA-6582730D5BCC-low.png" /><br /></div>
</li>
</ul>
<pre class="pre codeblock" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__CODEBLOCK_RGG_GTN_1VB"><code id="d31106e194" content="For Zigbee applications the System Sleep mode is only enabled when using the following device types - Multisensor, Intruder Alarm System and Color Scene controller as per the Zigbee End Device Spec. &#xA;There is no separate configuration that a user has to select to enable the System Sleep like for BLE Sleep&#xA;">For Zigbee applications the System Sleep mode is only enabled when using the following device types - Multisensor, Intruder Alarm System and Color Scene controller as per the Zigbee End Device Spec. 
There is no separate configuration that a user has to select to enable the System Sleep like for BLE Sleep
</code></pre><ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_SGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-EF0BC56D-605A-4736-9B4D-98525E1E87FA"> Upon enabling sleep mode, FreeRTOS related settings will be set automatically. <ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_TGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-49B4761E-0DE2-4155-B1A0-04DC9073751C"><p class="p">Tick Mode will be set to Tickless_Idle</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-37182CED-B1F0-4709-AD1E-16BF291D1FF6"><p class="p">Expected idle time before sleep will be set to 5 (ms)</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-2ECF8073-9D3E-442E-B759-CEB3010EAD14"><p class="p">Tick Hook will be enabled (For user to add any custom code needed to be executed within each tick interrupt)</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-05C85B4A-9F71-4C99-A2AE-1BC06CFBDE53"><p class="p">RTC peripheral library will be added and configured</p>
</li>
</ul>
<p class="p"><strong class="ph b">Note:</strong> RTC counter should not be reset (RTC_Timer32CounterSet()) arbitrarily when the system is running</p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_K23_SSN_1VB" src="GUID-6097CA1F-2532-4474-8F6F-AA5E6634C3EE-low.jpg" /><br /></div>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-CC15B768-43EE-4DF3-AB44-8E9EBE8DEA9D"><p class="p">RTC clock source should be set manually, there are 4 options to choose from</p>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_UGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-4BAFCAE7-DA8F-4D9D-BC88-B55540391657"><p class="p">FRC (±1% offset)</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-161EB48F-B3C5-47FC-B4B8-3A0C63A65EC8"><p class="p">LPRC ( with larger offset, &lt; ±5%)</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-D21177B8-19CA-43D5-B3F2-6650D3409BE3"><p class="p">POSC &lt;- Candidate of the clock source (better clock accuracy)</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-008260FD-1918-478B-BCCF-15419158BF74"><p class="p">SOSC &lt;- Candidate of the clock source (better clock accuracy)</p>
</li>
</ul>
<p class="p">Users can select POSC or SOSC as the RTC clock source. Choosing FRC and LPRC as clock sources for RTC will impact BLE connection stability. In this example SOSC is configured as RTC clock source.</p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-5550E43F-A4DB-40B8-9189-030725C72CB4"> In Mplab Code Configurator, Click Plugins select "Clock Configuration" from drop down menu <div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_QXZ_TSN_1VB" src="GUID-18544853-5F8D-4837-9BF7-A4F7E6D8897B-low.jpg" /><br /></div>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-9C62C6A4-C42D-498F-A88D-4FA5BB3282F9"> In Clock Diagram, <ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_VGG_GTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-907E6000-FD71-4AF6-B9B4-03308A74D3FB"><p class="p">Enable Secondary Oscillator (SOSC) by setting <code class="ph codeph">SOSCEN</code> to <code class="ph codeph">ON</code></p>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-36E646DB-29C8-4199-8790-70691E9222BE"><p class="p">Select <code class="ph codeph">SOSC</code> as clock source for <code class="ph codeph">VBKP_32KCSEL</code> and set <code class="ph codeph">LPCLK_MOD</code> to <code class="ph codeph">DIV_1_024</code> as hown in below below. </p>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_VYG_CTN_1VB" src="GUID-3122F851-ADC7-4D97-A37C-78F9EC3A85B3-low.jpg" /><br /></div>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_A2L_WSN_1VB" src="GUID-1EA46EEB-D935-4745-A998-47FEAE12F7C3-low.jpg" /><br /></div>
</li>
</ul>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-457EE29D-D73B-4949-A7A6-43F910F76D64"> All Unused pins in the application needs to be set in input mode and the pulldown should be enabled for these pins. This can be configured inside ports available in system component confguration options.<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_AQJ_QQN_1VB" src="GUID-CE7EF25C-68D5-4EE7-8A4D-893190A081EE-low.png" /><br /></div>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-E78E47EC-3273-4473-BB9E-A63AD0281456">The Pin PB5 functionality should be changed to GPIO to disable the JTAG functionality for reduced power consumption.<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_L2Z_YQN_1VB" src="GUID-52A97E7E-2EFB-42C7-9C30-193CA1F7192C-low.png" /><br /></div>
</li>
<li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-697E02E9-81CB-4911-B962-5D205AD88FF3">The PMU mode can be set to BUCK_PWM mode to attain less power consumption and the settings is available as part of Device Support as shown in the figure Below.<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_PQS_GRN_1VB" src="GUID-14D2EE7D-1D52-4529-BE05-6784933CCF04-low.png" /><br /></div>
</li>
</ul>
</div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SECTION_ILG_GTN_1VB"><h2 class="title sectiontitle">BLE Zigbee Provisioning Manual Code Configuration</h2></div>
<div class="section" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__SECTION_WGG_GTN_1VB"><ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_BCL_KTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-FACE9F2A-11A1-4C5E-ACFB-22CFF338BAD4">Open app.c file and include the header file app_prov.h as shown in below figure.</li>
</ul>
<pre class="pre codeblock" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__CODEBLOCK_KGD_3TN_1VB"><code id="d31106e290" content="#include &#34;app_prov/app_prov.h&#34;">#include "app_prov/app_prov.h"</code></pre><div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_Z4M_JTN_1VB" src="GUID-40D25799-8680-453D-BEF4-478A3C26D3FB-low.jpg" /><br /></div>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_JSX_LTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-0369747E-0059-4D61-BDA4-7922C5D81E2A">In app.c, Add the following code after APP_BleStackInit() in APP_Tasks function.</li>
</ul>
<div class="p"><pre class="pre codeblock" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__CODEBLOCK_F1N_LRN_1VB"><code id="d31106e298" content="APP_Prov_TRPS_Init();">APP_Prov_TRPS_Init();</code></pre></div>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_MGP_MRN_1VB" src="GUID-7325A497-DD67-4B95-A573-B3D4F7610083-low.png" /><br /></div>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_GPD_NTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-0F86330D-8018-4A16-9DF8-D05C25B0063B">Open app_ble_handler.c file located in app_ble project folder. In APP_BleGapEvtHandler() function, add the below code as shown in figure.</li>
</ul>
<div class="p"><pre class="pre codeblock" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__CODEBLOCK_KCN_PRN_1VB"><code id="d31106e306" content="extern void APP_BleGapConnEvtHandler(BLE_GAP_Event_T *p_event);&#xA;APP_BleGapConnEvtHandler(p_event);">extern void APP_BleGapConnEvtHandler(BLE_GAP_Event_T *p_event);
APP_BleGapConnEvtHandler(p_event);</code></pre></div>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_SGD_TRN_1VB" src="GUID-8AB14AB3-490E-4086-AD32-9B87076480E7-low.png" /><br /></div>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_J1S_NTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-5F94314B-B6B0-4B4B-9696-0B269158FA5F"> Open app_trsps_handler.c file. In APP_TrspsEvtHandler() function, add the below code as shown in figure. </li>
</ul>
<div class="p"><pre class="pre codeblock" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__CODEBLOCK_QBK_5RN_1VB"><code id="d31106e314" content="extern void APP_TRPS_EventHandler(BLE_TRSPS_Event_T *p_event);&#xA;APP_TRPS_EventHandler(p_event);">extern void APP_TRPS_EventHandler(BLE_TRSPS_Event_T *p_event);
APP_TRPS_EventHandler(p_event);</code></pre></div>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_UXW_XRN_1VB" src="GUID-230B92FF-40A3-413A-8939-DF84D1010C80-low.png" /><br /></div>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_XPD_4TN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-CDB9BCEA-D139-4D0F-AE35-51DE2A29E4F2">Open app_zigbee_handler.c file located in app_zigbee project folder. In Zigbee_Event_Handler() function, add the below code as shown in figure. </li>
</ul>
<div class="p"><pre class="pre codeblock" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__CODEBLOCK_EXZ_YRN_1VB"><code id="d31106e323" content="extern void BZ_Prov_Zigbee_Event_Handler(APP_Zigbee_Event_t event);&#xA;BZ_Prov_Zigbee_Event_Handler(event);">extern void BZ_Prov_Zigbee_Event_Handler(APP_Zigbee_Event_t event);
BZ_Prov_Zigbee_Event_Handler(event);</code></pre></div>
<div class="p"><br /><img class="image" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__IMAGE_ZLB_CSN_1VB" src="GUID-2808BAC0-6094-4BAB-BAC6-5F746A7F4F06-low.png" /><br /></div>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_FHS_4TN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-23E1AF3A-1E1B-45D9-BFE5-0223B74FEA1A">Open app_user_edits.c file. Comment out or remove the #error line. Update the freertos_hooks.c as mentioned in app_user_edits.c file</li>
</ul>
<ul class="ul" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__UL_D4B_PTN_1VB"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-2C39078C-FE09-46E4-B785-89C8BFA8E981">Compile and Run the project in <span class="ph">WBZ451</span><p class="p"></p>
</li>
</ul>
<p class="p"><strong class="ph b">Demo Steps: commissioning</strong></p>
<p class="p">To Commission the Zigbee Multi-Sensor device, follow the step mentioned here</p>
<p class="p"><strong class="ph b">Protocol Exchange</strong></p>
<ol class="ol" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-523B47E8-9E77-4D0B-949D-751E5241516E"><li class="li" id="GUID-3D00CE26-A97E-44F4-9A17-A9CC112DAF43__GUID-8224746F-B9CF-4392-8FC1-0E853C1024BA"><span class="indent-level-default">1.</span><p class="p">The communication protocol exchange between BLE Provisioner mobile app and <span class="ph">WBZ451</span> module (BLE peripheral) is explained <a class="xref" href="GUID-998705A8-0286-429C-B35C-0F5E95D94A3D.html">here</a></p>
</li>
</ol>
</div>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-2A54CAC1-1370-4448-8768-E6C7B8CFCA23.html" title="Documentation describing steps to test and develop the precompiled BLE and Zigbee coexistence application examples.">Getting Started With Multiprotocol Applications</a></div>
</div>
</div></body>
</html>