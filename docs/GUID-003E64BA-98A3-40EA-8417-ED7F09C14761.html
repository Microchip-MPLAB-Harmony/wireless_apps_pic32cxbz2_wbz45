<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Device Firmware Upgrade Over Serial" />
<meta name="DC.relation" scheme="URI" content="GUID-D7A53CEA-74B4-4CAA-A5D4-F69980188D1B.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761" />
<meta name="DC.language" content="en-US" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>Device Firmware Upgrade Over Serial</title>
<meta name="Microsoft.Help.Id" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-003E64BA-98A3-40EA-8417-ED7F09C14761" />
<meta name="Microsoft.Help.TocParent" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-D7A53CEA-74B4-4CAA-A5D4-F69980188D1B" />
<meta name="Microsoft.Help.TocOrder" content="1" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="Software Development Reference A 09/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-003E64BA-98A3-40EA-8417-ED7F09C14761"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761">
<h1 class="title topictitle1" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-6F6646B5-1FB2-469B-8B5A-55ABB0BED96C" style="">Device Firmware Upgrade Over Serial</h1><div class="body"><p class="p">Device Firmware Upgrade(DFU) over serial is the functionality in Bootloader that user uses it to load new image received over serial interface and write into the flash. PC GUI tool(MicrochipUtilityTool.exe) and Python Script are two methods used for DFU over serial. Followings are user guide and demostrantion steps using these two methods to do DFU over serial, the demonstration is to upgrade <em class="ph i">ble_sensor</em> user application with a new image.</p>
<div class="section" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-A1369926-0B48-4E78-92AB-B7F6A46DE89C"><h2 class="title sectiontitle">DFU over Serial Using MicrochipUtility Tool</h2></div>
<p class="p">MicrochipUtility is a GUI tool, it suppors OTAU over serial, Zigbee OTAU. The utility tool is provided in Microchip website <a class="xref" href="https://ww1.microchip.com/downloads/aemDocuments/documents/WSG/ProductDocuments/SoftwareTools/MicrochipUtilityTool_v1_1.zip" target="_blank">link</a>. For its user guide and demonstration using this tool to do serial DFU, click <a class="xref" href="GUID-E24160FD-C371-4A9C-99F3-CB7C84DFD5C6.html">Serial Bootloader Demo</a>.</p>
<div class="section" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-0E99ACA1-DC71-48D2-B157-5FDFDD92D72D"><h2 class="title sectiontitle">DFU over Serial Using Python Script</h2></div>
<p class="p"><strong class="ph b"><em class="ph i">Pre-requisite:</em></strong></p>
<ul class="ul"><li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-DF7C1867-40FB-4267-A158-B912F6A85AC8"><p class="p"><strong class="ph b">ble_sensor</strong> project as current user application(version 1.0.0.0) <em class="ph i">wireless_apps_pic32cxbz2_wbz45\apps\ble\advanced_applications\ble_sensor\firmware</em></p>
</li>
<li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-EDC8600F-7594-4B43-B456-5C84D7DBB3D1"><p class="p">Precompiled <strong class="ph b">ble_sensor</strong> new image(binary file): <em class="ph i">wireless_apps_pic32cxbz2_wbz45\apps\ble\advanced_applications\ble_sensor\precompiled_hex\ble_sensor.X.production.signed_uart_1.0.0.1.bin</em></p>
</li>
<li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-19E01D3F-B967-4848-9ECB-80906EBBB304"><p class="p"><strong class="ph b">Bootloader</strong>:</p>
<ul class="ul"><li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-7888705D-51CF-42B3-9501-5CBA5619F611"><p class="p">Precompiled hex file for GPIO Trigger mode DFU: <em class="ph i">wireless_apps_pic32cxbz2_wbz45\apps\bootloader\bootloader\precompiled_hex\bootloader.X.production.hex</em></p>
</li>
<li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-7888705D-51CF-42B3-9501-5CBA5619F611"><p class="p">Precompiled hex file for Timer Based Trigger DFU: <em class="ph i">wireless_apps_pic32cxbz2_wbz45\apps\bootloader\bootloader\precompiled_hex\bootloader_timer.X.production.hex</em></p>
</li>
</ul>
</li>
<li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-59CB7888-8192-4BC3-A903-94EC7B4E49C5"><p class="p">Python Script Files:</p>
<ul class="ul"><li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-59CB7888-8192-4BC3-A903-94EC7B4E49C5"><p class="p">For GPIO Trigger mode DFU: <strong class="ph b">flash_load_2ndSlot.py, progctrl.py</strong> (<em class="ph i">wireless_pic32cxbz_wbz\utilities\pic32cx-bz\dfuPythonScripts\</em>)</p>
</li>
<li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-59CB7888-8192-4BC3-A903-94EC7B4E49C5"><p class="p">For Timer Based Trigger DFU: <strong class="ph b">flash_load_2ndSlot_timer.py, progctrlOptimized.py</strong> (<em class="ph i">wireless_pic32cxbz_wbz\utilities\pic32cx-bz\dfuPythonScripts\</em>)</p>
</li>
</ul>
</li>
<li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-891391D7-F155-443C-A3CA-2E9C9EC1B0C1"><p class="p">Hardware: <strong class="ph b"><span class="ph">WBZ451</span> Curiosity Board</strong></p>
</li>
</ul>
<p class="p"><strong class="ph b"><em class="ph i"><u class="ph u">How to Run Python Script:</u></em></strong></p>
<p class="p"><u class="ph u">For GPIO Trigger DFU, execute python script by below command:</u></p>
<p class="p"><strong class="ph b">python flash_load_2ndSlot.py -i image.bin</strong></p>
<p class="p"><u class="ph u">For Timer Based Trigger DFU, execute python script by below command:</u></p>
<p class="p"><strong class="ph b">python flash_load_2ndSlot_timer.py -i image.bin</strong></p>
<p class="p"><strong class="ph b">image.bin</strong> is the binary file of new user image, this binary file is generated from user application by MPLAB X IDE. It could be other file name from user’s own application, it may have path name before the file.</p>
<p class="p"><strong class="ph b"><em class="ph i">DFU over Serial Demonstration:</em></strong></p>
<p class="p">Following are steps to operate DFU over seiral, programing a new user image by using Bootloader.</p>
<ul class="ul"><li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-AA802743-A994-4216-98B1-ADA71BBA6DA0"><p class="p"><strong class="ph b">Preparation: Create and Program Unified image</strong></p>
</li>
</ul>
<div class="p">Before DFU operation, make sure the unified image containing bootloader and current user application are created and programmed. To do this, open <strong class="ph b">ble_sensor</strong> project with MPLAB X IDE. If user click <strong class="ph b">Lodables</strong>, will see the bootloader precompiled hex file is already added into the project.<div class="fig fignone" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-9ABEAB57-CEAB-4C87-9C3A-F38285B1A173"><div class="figcap"><span class="fig--title-label">Figure 1. </span>Verify Loadable File in ble_sensor Project. </div><span class="desc figdesc"><p class="p">Click Loadables, Verify Bootloader Precompiled Hex file is Added</p>
</span><img class="image" src="GUID-518D9E86-D0EA-48E8-8786-B08E31C8DE51-low.jpg" /></div>
</div>
<p class="p"><strong class="ph b">Tip</strong>: For Timer Based Trigger DFU, user need to remove this hex file that is for GPIO Trigger DFU, and add another timer based bootloader hex(<em class="ph i">bootloader_timer.X.production.hex</em>) as <strong class="ph b">Loadable File</strong><em class="ph i">.</em></p>
<p class="p">Then on the IDE Tools bar, click <strong class="ph b">Clean and Build Main Project</strong> icon to build the project. Since the project has a loadable hex file added, code building will create a unified image hex file <em class="ph i">ble_sensor.X.production.signed.unified.hex</em></p>
<div class="p"><strong class="ph b">Tip</strong>: Another binary file named <em class="ph i">ble_sensor.X.production.signed.bin</em> is created at the same time. This binary file will be the targe image file used by bootloader for DFU. However, in this demonstration, we will use another precomipled binary file as target image, since that image contains different firmware version to tell user DFU is successful.<div class="fig fignone" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-646E966D-4A65-4545-8BD7-EC7CB49DE5A5"><div class="figcap"><span class="fig--title-label">Figure 2. </span>Build Unified Image. </div><span class="desc figdesc"><p class="p">Unified Image Contains Both User Application and Bootloader</p>
</span><img class="image" src="GUID-B7F7E57A-B98A-4D63-A9F1-29D08E051C1A-low.jpg" /></div>
</div>
<div class="p">Once code building is finished, on the IDE Tools bar, click <strong class="ph b">Make and Program Device Main Project</strong> icon to program device, the unified image will be programmed into <span class="ph">WBZ451</span> Curiosity board.<div class="fig fignone" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-A9B517BA-07E5-4C14-BADB-448C25A8E535"><div class="figcap"><span class="fig--title-label">Figure 3. </span>Program Unified Image. </div><span class="desc figdesc"><p class="p">Program Unified Image to Board</p>
</span><img class="image" src="GUID-6B3A91FA-69E9-4EE5-ADC5-5976897B400F-low.jpg" /></div>
Now the board is ready, followings we will use DFU over serial to upgrade it to a new image <em class="ph i">ble_sensor.X.production.signed_uart_1.0.0.1.bin</em></div>
<p class="p">For creating unified image, user can refer to <a class="xref" href="GUID-399616BF-E65E-43B3-9831-4B19472A5EF0.html">Bootloader</a> - section <u class="ph u">Configure User Application to use Bootloader</u> - <u class="ph u">Add Bootloader as Lodable File/Project to Create Unified Image</u> to know more details.</p>
<ul class="ul"><li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-533CB521-4638-4BE7-AD85-16FA29416048"><p class="p"><strong class="ph b">Enter into DFU Mode</strong></p>
</li>
</ul>
<p class="p">For the provided bootloader example, DFU mode is triggered by SW2 Button on <span class="ph">WBZ451</span> Curiosity board. So press and hold SW2 Button first, then short press Reset button(SW1) to restart the firmware, the firmware will enter DFU mode. Opening <strong class="ph b">Tera Term</strong> on PC, and configure it as <strong class="ph b">115200/8bit/none Parity/1 Stop bit</strong>, will see the message output as “DFU Now!”.</p>
<div class="p"><div class="fig fignone" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-30DA15F4-E4F9-4238-B19C-2C9DE6FFB815"><div class="figcap"><span class="fig--title-label">Figure 4. </span>Ener Into DFU Mode. </div><span class="desc figdesc"><p class="p">Display Message "DFU Now!" in Tera Term</p>
</span><img class="image" src="GUID-CB40589C-D0F3-464B-870A-D93B21114FD2-low.jpg" /></div>
</div>
<p class="p">This message means the board is under DFU mode.</p>
<ul class="ul"><li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-EA9F4AB1-7E35-49DF-A69C-17011F4ACB6F"><p class="p"><strong class="ph b">Run Python Script to do DFU</strong></p>
</li>
</ul>
<p class="p">Close <strong class="ph b">Tera Term</strong> and open Windows <strong class="ph b">Command Prompt</strong>, go to the directory where python script files and binary image file are located and execute python script as below:</p>
<p class="p"><strong class="ph b">python flash_load_2ndSlot.py -i ble_sensor.X.production.signed_uart_1.0.0.1.bin</strong></p>
<p class="p">To run above python script, user may need to copy those python script files and binary image file into a same folder. However, python script also support file with aboslute path name or relative path name.</p>
<div class="p"><div class="fig fignone" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-3B272C15-9718-4943-B813-8DD7BD92F008"><div class="figcap"><span class="fig--title-label">Figure 5. </span>Run Python Script to Do DFU (GPIO Trigger Mode). </div><span class="desc figdesc"><p class="p">Execute Python Script and see DFU Progress</p>
</span><img class="image" src="GUID-53B123B8-0833-4558-9CA9-F9B82F561582-low.jpg" /></div>
</div>
<p class="p"><strong class="ph b">Tip</strong>: For Timer Based Trigger DFU, it uses different python script files, execute python script as below:</p>
<p class="p"><strong class="ph b">python flash_load_2ndSlot_timer.py -i ble_sensor.X.production.signed_uart_1.0.0.1.bin</strong></p>
<div class="p">For Timer Based Trigger DFU, it will wait to capture DFU mode window of the bootloader, so for operating Timer Based Trigger DFU, need execute python script first, then reset the board and wait for a while. If python script has captured DFU window, it will start DFU process. Otherwise, user will need another reset the board until DFU is started. Referring to figure below, after python script is executed, it keep waiting and reminding user to reset the board until DFU progress starts to be shown.<div class="fig fignone" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-922BB031-6A5E-4B3F-9145-6156EB00BB93"><div class="figcap"><span class="fig--title-label">Figure 6. </span>Run Python Script (Timer Based Trigger). </div><span class="desc figdesc"><p class="p">Execute Python Script, Reset Board, and see DFU Progress</p>
</span><img class="image" src="GUID-CF2E9241-1E5C-449F-9E7E-47DF07963874-low.jpg" /></div>
</div>
<p class="p">The % progress will tell the DFU progress. Once it is finished as 100%, the new image is copied to slot1 of internal flash memory.</p>
<ul class="ul"><li class="li" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-45BCBA62-B237-4545-924C-CA15A95AC769"><p class="p"><strong class="ph b">Reset Board to Start New Firmware</strong></p>
</li>
</ul>
<p class="p">Python script has not supported firmware automatical reboot after DFU completion, so need manually reset the board to start new firmware.</p>
<p class="p">Once DFU progress achieves 100% complete, close Windows <strong class="ph b">Command Prompt</strong> and open <strong class="ph b">Tera Term</strong> to see the message output. On the board, press the Reset button(SW1) to restart, the bootloader will then copy new firmware from flash memory slot1 to slot0. After that, bootloader will jump and start new user image in slot0. On Tera Term, user will see messages as shown below, original firmware version is 1.0.0.0, now firmware version is 1.0.0.1, the DFU is successful.</p>
<div class="p"><div class="fig fignone" id="GUID-003E64BA-98A3-40EA-8417-ED7F09C14761__GUID-023EF6FB-9EE5-4D05-8786-D71BDFDB186F"><div class="figcap"><span class="fig--title-label">Figure 7. </span>Reset Board to Star New Firmware. </div><span class="desc figdesc"><p class="p">Display Message About Firmware Erase/Copy/Verify in Tera Term</p>
</span><img class="image" src="GUID-0369BAE8-420B-46BD-A2F8-3EC64F24776A-low.jpg" /></div>
</div>
<p class="p"><strong class="ph b">Tip</strong>: For Timer Based Trigger DFU, it doesn't need manual reset the board to start new image. Timer Based Trigger bootloader will automatically copy new user image and jump to start it.</p>
<p class="p"><strong class="ph b">Tip</strong>: Depending on if user has enabled <strong class="ph b">Use Firmware Signature Verification API in Bootloader</strong> in <strong class="ph b">Bootloader Services</strong> component or not, the bootloader code may or may not verify metaheader and firmware using specified method. If bootloader has verified metaheader and firmware, their verification result will be displayed in Tera Term.</p>
<p class="p"></p>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-D7A53CEA-74B4-4CAA-A5D4-F69980188D1B.html" title="This section documents how to enable FW updates in your design, whether its serial or over the air">How-to: Firmware and OTA Updates</a></div>
</div>
</div></body>
</html>