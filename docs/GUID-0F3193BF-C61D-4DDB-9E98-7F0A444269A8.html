<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="BLE Custom service" />
<meta name="DC.relation" scheme="URI" content="GUID-B3B46369-F5B4-401B-8405-658BE34988F4.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8" />
<meta name="DC.language" content="en-US" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>BLE Custom service</title>
<meta name="Microsoft.Help.Id" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8" />
<meta name="Microsoft.Help.TocParent" content="GUID-A5330D3A-9F51-4A26-B71D-8503A493DF9C-GUID-B3B46369-F5B4-401B-8405-658BE34988F4" />
<meta name="Microsoft.Help.TocOrder" content="6" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="Software Development Reference A 09/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8">
<h1 class="title topictitle1" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-BEC8E4E5-9B4C-4943-874D-25D50AEF76D2" style="">BLE Custom service</h1><div class="body"><p class="p"><u class="ph u"><a class="xref" href="GUID-17DABF04-E5D8-4201-A746-2FC244450A19.html">Getting Started</a></u></p>
<p class="p"><u class="ph u"><a class="xref" href="GUID-B3B46369-F5B4-401B-8405-658BE34988F4.html">Getting Started with Peripheral Building Blocks</a></u></p>
<p class="p"><u class="ph u"><a class="xref" href="GUID-F9A0C390-C124-49A7-9F22-157D20BFBE5D.html">BLE Connection</a></u> <strong class="ph b">–&gt;</strong> <u class="ph u"><a class="xref" href="#GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8">BLE Custom Service</a></u></p>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-0A942040-F974-455F-8FD7-95AC500F5A33"><h2 class="title sectiontitle">Introduction</h2></div>
<p class="p">This tutorial will help users create a peripheral device with custom profile and control the RGB LEDs on the <span class="ph">WBZ451</span> Curiosity board and button on the <span class="ph">WBZ451</span> Curiosity board shall be used to enable or disable the LED status. Peripheral device will be <span class="ph">WBZ451</span> Device and Central device can be a Smartphone with Light Blue App.The instructions mentioned below are applicable for a BLE Peripheral device.</p>
<p class="p">Users of this document can choose to just run the precompiled Application Example hex file on the <span class="ph">WBZ451</span> Curiosity board and experience the demo or can go through the steps involved in developing this Application from scratch.</p>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-C0352C80-A168-45C6-89EF-0B6DE5D6B3B4"><h2 class="title sectiontitle">Recommended Reads</h2></div>
<ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-2258FC17-1EC9-40A5-82DA-19D352E6B06D"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-CAD8F3F5-6F91-4815-91B0-B52C492B0ABC"><span class="indent-level-default">1.</span><p class="p"><a class="xref" href="https://onlinedocs.microchip.com/pr/GUID-C5EAF60E-9124-427C-A0F1-F2DBE662EA92-en-US-1/index.html?GUID-222749FE-01C5-43B6-A5C7-CD82B3FC7F5F" target="_blank">BLE Software Specification</a></p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-CAD8F3F5-6F91-4815-91B0-B52C492B0ABC"><span class="indent-level-default">2.</span><p class="p"><a class="xref" href="GUID-F9A0C390-C124-49A7-9F22-157D20BFBE5D.html">BLE Connection</a></p>
</li>
</ol>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-A964CAA3-59B6-4653-BD68-533A405424C2"><h2 class="title sectiontitle">Hardware Required</h2></div>
<div class="p">
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-1B8A9047-331F-4F5A-AEE8-5DDE03910FF7" class="table" frame="border" border="1" rules="all"><col style="width:50%" /><col style="width:50%" /><tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;"><span><p class="p">Tool Required</p>
</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;"><span><p class="p">Qty</p>
</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;"><span><strong class="ph b"><span class="ph">WBZ451</span> Curiosity Board</strong></span></td>
<td class="entry cellrowborder" style="vertical-align:middle;"><span><p class="p">1</p>
</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;"><span><p class="p">Micro USB Cable</p>
</span></td>
<td class="entry cellrowborder" style="vertical-align:middle;"><span><p class="p">1</p>
</span></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-C332DB1D-7014-4E9D-99C8-A91745C3E600"><h2 class="title sectiontitle">SDK Setup</h2></div>
<ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-36FEB775-06F7-4FAB-8525-0571567C5677"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-049B394E-4DD7-4A32-9EA1-73D2892B72FF"><span class="indent-level-default">1.</span><p class="p"><a class="xref" href="GUID-2AD37FE2-1915-4E34-9A05-79E3810726D7.html" title="Steps to install IDE, compiler, tool chain, BLE, Zigbee stacks and application examples on your PC">Getting Started with Software Development</a></p>
</li>
</ol>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__SOFTWARE"><h2 class="title sectiontitle">Software</h2><ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-A718D056-243F-4A86-B866-DB26CF0CC78E"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-CA572664-CE7A-4801-A326-474EBDAE53B2"><span class="indent-level-default">1.</span><p class="p"><a class="xref" href="https://ttssh2.osdn.jp/index.html.en" target="_blank">TeraTerm</a></p>
</li>
</ol>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__SMARTPHONE-APP"><h2 class="title sectiontitle">Smartphone App</h2><ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-645EC60F-8F8C-4E10-B9C9-9405EBFF4FD7"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-BE877A3E-A055-40F3-ADE6-141F95F6D9E1"><span class="indent-level-default">1.</span><p class="p">Light Blue</p>
</li>
</ol>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__PROGRAMMING-THE-PRECOMPILED-HEX-FILE-OR-APPLICATION-EXAMPLE"><h2 class="title sectiontitle">Programming the precompiled hex file or Application Example</h2><p class="p"><strong class="ph b">Programming the hex file using MPLABX IPE</strong></p>
<ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-86DFBE12-A651-42BA-B28A-3BBE8A45957A"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-615EAAB4-CA37-48DC-B8D6-A517E037C6B2"><span class="indent-level-default">1.</span><p class="p">Precompiled Hex file is located in "<span class="ph">&lt;Harmony Content
        Path&gt;\wireless_apps_pic32cxbz2_wbz45</span>\apps\ble\building_blocks\peripheral\profiles_services\custom_service\hex" folder</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-32A5BDB1-E7AC-43F3-8DE0-1C2A0C6B2BA4"><span class="indent-level-default">2.</span><p class="p">Follow the steps mentioned <a class="xref" href="https://microchipdeveloper.com/ipe:programming-device" target="_blank">here</a></p>
</li>
</ol>
<p class="p"><strong class="ph b">Caution:</strong> Users should choose the correct Device and Tool information</p>
<p class="p"><strong class="ph b">Programming the Application using MPLABX IDE</strong></p>
<ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-38E32D75-4A7E-4FCA-AB19-EAC72582B498"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-33A1AC6E-81BD-4873-9C21-CC3BF516AAC9"><span class="indent-level-default">1.</span><p class="p">Follow steps mentioned in of <a class="xref" href="GUID-EA74172C-595E-4A34-B359-D42EE443F0EC.html" title="Here is how to open, build and program an existing application example">Running a Precompiled Example</a> document</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-87FDAD2C-721F-4193-A9F9-C5DFD00D8841"><span class="indent-level-default">2.</span><p class="p">Open and program the Application Example "peripheral_trp_uart.x" located in "<span class="ph">&lt;Harmony Content
        Path&gt;\wireless_apps_pic32cxbz2_wbz45</span>\apps\ble\building_blocks\peripheral\profiles_services\custom_service\firmware" using MPLABX IDE</p>
</li>
</ol>
<p class="p"><dfn class="term">&lt;Harmony Content Path&gt;</dfn> <a class="xref" href="GUID-A55E9342-CE44-4A91-86BB-FEC6706FCD1C.html#GUID-A55E9342-CE44-4A91-86BB-FEC6706FCD1C__GUID-C6B23D06-5DF8-4D73-B997-AC22020FE9D3">how to find what is my Harmony Content Path</a></p>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__DEMO-DESCRIPTION"><h2 class="title sectiontitle">Demo Description</h2>Upon programming the demo application, <span class="ph">WBZ451</span> will start Advertising (connectable), central device (Smartphone) scanning for these advertisements will connect to the device. In case of using Light Blue App search for “pic32cx-bz” and connect. After a connection has been made Button and RGB LED status can be read and RGB LED can be controlled from the central device (Smartphone - Light Blue App). Button status will be notified if subscribed from central device (Smartphone). <p class="p">Demo will print various events on a terminal emulator like Tera Term @ (Speed: 115200, Data: 8-bit,Partity: none, stop bits: bit, Flow control: none)</p>
<ul class="ul"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-1D51BC33-4F73-470D-9653-6975FEEFB70B"><p class="p">Start of the advertisement - "[BLE] Device Initialized. Ready for connection"</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-9B0DC07E-A55C-43B1-BAD6-B9C37AD9AFF0"><p class="p">Connection completed - "[BLE] Connected to Peer Device: "&amp;" [BLE ] Connection Handle:"</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-02A19A61-EAB2-4A7A-8A1E-4A81759248FF"><p class="p">Write Request Received - "[BLE] GATT Write ATTR Handle 0x"</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-BA5DAE54-C278-41F0-94BF-DA34710CBC5F"><p class="p">Read Request Received - "[BLE] GATT Read ATTR Handle 0x"</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-9AB9C1C4-9A37-4B80-A16C-35A4FDAC8897"><p class="p">Received RGB Data - "[BLE] RGB LED data 0x 0x 0x"</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-698A342C-62F7-43EF-80A4-C86684684658"><p class="p">Button press event - “[BLE] Custom Service Button Event : RGB LED ON” &amp; “[BLE] Custom Service Button Event : RGB LED OFF”</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-D38E4028-6000-4846-AD98-CA658F8037D6"><p class="p">BLE Disconnected - “[BLE] Disconnected Handle: %d, Reason: 0x&lt;reason_code&gt;”.</p>
</li>
</ul>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__TESTING"><h2 class="title sectiontitle">Testing</h2><p class="p">This section assumes that user has programmed the Application Example on the <span class="ph">WBZ451</span> Curiosity Board <strong class="ph b">Demo Experience when using a Smartphone (Light Blue App) as Central Device</strong></p>
<div class="p"><ul class="ul"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-CFB775DB-DF26-4AAE-BFF7-BE353F9D4BED"><p class="p">Reset the <span class="ph">WBZ451</span> Curiosity board, Open Terminal emulator like Tera Term, select the right COM port@ (Speed: 115200, Data: 8-bit, Parity: none, stop bits: 1 bit, Flow control: none).</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-768DDDF6-1DF9-4D00-AA89-D185312E4E8E"><div class="p">open Light Blue App on your smartphone, Search and select the advertisement with Device Name "pic32cx-bz"<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-1D857F79-B461-467C-A678-FC4BF0AA6627"><div class="figcap"><span class="fig--title-label">Figure 1. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-091E441D-3DB4-4392-B91E-0F328BFB173B-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-E86FE1B8-EB8A-4901-A244-662ADEAECF49"><div class="p">Once connected on Blue App on your smartphone, basic info like Adervetisement Data and Device information will be avilable"<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-D7966AFE-AFDF-43CA-AAFF-E849F4E8A329"><div class="figcap"><span class="fig--title-label">Figure 2. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-47F8B0C3-FD7A-4F47-9964-2F772E305018-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-C7E7CCF8-10F0-4416-BF1E-58838A59A894"><div class="p">Once connected on Blue App on your smartphone, find the custom service with the UUID 4d434850-5255-42d0-aef8-881facf4ceea" Two characteristics will be avilable on the custom service.Button characteristics with Readable,Notify property and RGB LED characteristics with Readable,Writable property<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-24FE6420-BCF8-4BBD-A9E0-3C27EEEAF61D"><div class="figcap"><span class="fig--title-label">Figure 3. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-F51034A7-A044-4DC9-9D1D-D0E61508D0AB-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-6AD1CDDB-90C8-41C9-A290-62BC67552AFB"><div class="p">Click on the button characteristics which will have read option and subscribe. Read will give the current status of the button<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-A1C6BF32-2153-4D7B-B6FC-231DB7C6C4E0"><div class="figcap"><span class="fig--title-label">Figure 4. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-271A8F5C-6E99-4B6F-9249-222D14C837BE-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-6F949C3C-9317-49D2-8103-559B7D1484C4"><div class="p">Click on the button characteristics subscribe option to listen for button change events.Button press activity will be notified to the central device without read intiated and toggle the RGB LEDs. <div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-5344623B-DBB8-4701-8ACD-82B4DB3D4FF6"><div class="figcap"><span class="fig--title-label">Figure 5. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-B22508BF-B804-4697-8477-AF3A093F922D-low.png" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-F9844FFF-DF5F-4B10-A34B-B80B50C4996E"><div class="figcap"><span class="fig--title-label">Figure 6. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-160CDE77-27CA-4C2E-B78F-3584C64338DD-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-792DA5AA-4046-4A2F-BDE4-C67A2204449A"><div class="p">Click on the RGB LED characteristics which will have read and write option. Read will give the current values stored for the RGB LEDs.Value of zero will turn off the LED. Other than zero value will turn on LED.<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-A529683C-B34D-4893-A586-CA26F0938460"><div class="figcap"><span class="fig--title-label">Figure 7. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-271A8F5C-6E99-4B6F-9249-222D14C837BE-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-4CBE544F-AC7A-4B5C-868C-EA1D6588CF0C"><div class="p">Click on the button characteristics write option provides option to write info which will change the RGB LED on/off condition.Read again to get the updated value for RGB LEDs. <div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-CF1B5CF0-0829-42D2-B644-1E3416478DA0"><div class="figcap"><span class="fig--title-label">Figure 8. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-7206F863-B741-4DF7-A2D6-9953249B95E2-low.png" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-AC758523-3AA8-434E-B9E6-C8649D1B043E"><div class="figcap"><span class="fig--title-label">Figure 9. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-7E56E300-320B-4FE5-8AF4-FFD921FAEED3-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-B7969A8A-E672-428A-9007-8C2C3F5CEBED"><div class="p">press back to disconnect the ble connection. Disconnected device will advertise again.<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-C156F9DC-BF48-4147-A48D-3095B4156154"><div class="figcap"><span class="fig--title-label">Figure 10. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-880F4C5B-4B9E-4C9D-9E74-7891C338C1D6-low.png" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-45AE6354-15BA-421A-9C36-3D6C09E732B5"><p class="p">Every event will be notified in the terminal emulator.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__DEVELOPING-THIS-APPLICATION-FROM-SCRATCH-USING-MPLAB-CODE-CONFIGURATOR"><h2 class="title sectiontitle">Developing this Application from scratch using MPLAB Code Configurator</h2><p class="p">This section explains the steps required by a user to develop this application example from scratch using MPLABx Code Configurator</p>
<p class="p"><strong class="ph b">Tip:</strong> New users of MPLAB Code Configurator are recommended to go through the <a class="xref" href="https://onlinedocs.microchip.com/pr/GUID-1F7007B8-9A46-4D03-AEED-650357BA760D-en-US-6/index.html?GUID-B5D058F5-1D0B-4720-8649-ACE5C0EEE2C0" target="_blank">overview</a>.</p>
<ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-0508BA08-476E-4B8C-897F-5D727437011C"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-0052D593-6E7C-4E49-8528-79516F7C4F3A"><span class="indent-level-default">1.</span><p class="p">Create a new MCC Harmony Project -- <a class="xref" href="GUID-B86E8493-D00D-46EF-8624-D412342147F0.html">link</a> for instructions</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-7CB243F8-58EA-444F-A5BE-BFB66A4555DD"><span class="indent-level-default">2.</span><p class="p">Import component configuration -- This step helps users setup the basic components and configuration required to develop this application. The imported file is of format .mc3 and is located in the path "<span class="ph">&lt;Harmony Content
        Path&gt;\wireless_apps_pic32cxbz2_wbz45</span>\apps\ble\building_blocks\peripheral\profiles_services\custom_service\firmware\custom_service.X". Users should follow the instructions mentioned <a class="xref" href="GUID-F8FE2886-8A2C-4FC0-9956-C094CE44D162.html">here</a> to import the component configuration.</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-EB7DFB70-BEA4-4A8A-A93E-4E4E765ED566"><span class="indent-level-default">3.</span><p class="p">Accept Dependencies or satisfiers, select "Yes"</p>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-74F0392D-2C56-4907-9B94-35B978DA6C1E"><span class="indent-level-default">4.</span><div class="p">Verify if the Project Graph window has all the expected configuration<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-BF89A428-B2AA-4D91-B607-557C2CEB81B9"><div class="figcap"><span class="fig--title-label">Figure 11. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-2A74AB37-C0F6-4504-A5C7-4FD197F72BE6-low.jpg" /></div>
</div>
</li>
</ol>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__VERIFY-ADVERTISEMENTCONNECTION-AND-TRANSPARENT-UART-PROFILE-CONFIGURATION"><h2 class="title sectiontitle">Verify Custom Service Configuration</h2><ol class="ol" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-D85827D1-F72C-4ACD-8DDE-D140B9711447"><li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-70253091-984D-4FA0-B2A4-A7113429A1B9"><span class="indent-level-default">1.</span><div class="p">Select <strong class="ph b">BLE_Stack</strong> component in project graph<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-676F9FD7-91DA-49EE-8A05-E65C3204952A"><div class="figcap"><span class="fig--title-label">Figure 12. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-205C7DED-DCD8-409B-9D56-C04CF07063EB-low.jpg" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-49F45A23-EC42-43F9-BE97-F7EBA0C0D545"><span class="indent-level-default">2.</span><div class="p">Select <strong class="ph b">FreeRTOS</strong> component in project graph<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-8AE66CB8-445D-4521-955A-DF0780458FA3"><div class="figcap"><span class="fig--title-label">Figure 13. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-0D78549F-EAE6-4336-AB69-68D6D7E1A135-low.jpg" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-7F3199CE-1551-4BB1-9BD2-77662D257D89"><span class="indent-level-default">3.</span><div class="p">Select <strong class="ph b">SERCOM0</strong> component in project graph<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-52B7FBED-FB5E-4F79-9BD1-4648AEFF3ACE"><div class="figcap"><span class="fig--title-label">Figure 14. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-64BBE9A9-1984-48FA-8CCF-35A9A4316B80-low.jpg" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-5218631C-68A9-4A82-A590-020E06F067BB"><span class="indent-level-default">4.</span><div class="p">Select <strong class="ph b">System</strong> component in project graph<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-995D72AB-F0C1-4C1B-BE37-BFACC410D14B"><div class="figcap"><span class="fig--title-label">Figure 15. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-753CB929-6884-49EF-B3D1-CBD2479022DC-low.jpg" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-DA256817-DDB9-4B16-BD51-C96C5140F0B4"><span class="indent-level-default">5.</span><div class="p">Select <strong class="ph b">EIC</strong> component in project graph<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-8F27595A-40FE-4E8B-AC87-43A9D72174ED"><div class="figcap"><span class="fig--title-label">Figure 16. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-4829F85C-FC8B-4D9C-BB8B-C368F0EDF3B9-low.jpg" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-500AA015-A420-40C2-AE1D-E6F3A094D453"><span class="indent-level-default">6.</span><div class="p">Select <strong class="ph b">Customized Service</strong> component in project graph<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-5EED6466-6BFF-409B-AD3D-17657A96FE9A"><div class="figcap"><span class="fig--title-label">Figure 17. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-603570B8-6571-4AEA-A3F5-D4EF9A9E5D3C-low.jpg" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-D5E881DE-D824-4CB0-BE7A-976DF62E417A"><div class="figcap"><span class="fig--title-label">Figure 18. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-21B08890-43CA-41EE-91E6-7C1269742994-low.jpg" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-1199F187-9FC2-426D-9BAE-49B434ABB723"><div class="figcap"><span class="fig--title-label">Figure 19. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-52ABED54-5F9A-4E1F-997C-282145BB34AC-low.jpg" /></div>
</div>
</li>
<li class="li" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-D1898752-E7AE-475C-9986-BC12B16D7502"><span class="indent-level-default">7.</span><p class="p">Verify the <strong class="ph b">Clock Configuration</strong> from tools option as per <a class="xref" href="GUID-101C8B73-AD8E-4845-831A-DC498B147435.html#GUID-101C8B73-AD8E-4845-831A-DC498B147435__GUID-BDC8B1B3-C8E9-491F-A0A8-20EB5BF0AC70">low power guide</a>.</p>
</li>
</ol>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GENERATE-CODE-LINK-FOR-INSTRUCTIONS"><h2 class="title sectiontitle">Generate Code</h2>Instructions on<a class="xref" href="GUID-9C28F407-4879-4174-9963-2CF34161398E.html">how to Generate Code</a></div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__FILES-AND-ROUTINES-AUTOMATICALLY-GENERATED-BY-THE-MCC"><h2 class="title sectiontitle">Files and Routines Automatically generated by the MCC</h2><div class="p">After generating the program source from MCC interface by clicking Generate Code, the BLE configuration can be found in the following project directories<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-E9FE00AC-DA9C-42F1-89DA-5A6C4043BFCB"><div class="figcap"><span class="fig--title-label">Figure 20. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-97F3AFB8-8C71-4EAD-86F1-22BE7B2C7173-low.jpg" /></div>
</div>
<p class="p">The <a class="xref" href="http://ww1.microchip.com/downloads/en/DeviceDoc/MPLAB%20Harmony%20OSAL%20Libraries%20Help%20v2.06.pdf" target="_blank">OSAL</a>, RF System, BLE System initialization routine executed during program initialization can be found in the project files. This initialization routine is automatically generated by the MCC</p>
<br /><img class="image" src="GUID-A8152D7D-0C8E-4C1D-89FB-7EFF9979AB30-low.png" /><br />
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-8E992053-6A10-42DA-A8AC-F38FD88CBAAA" class="table" frame="void" border="1" rules="all"><col style="width:50%" /><col style="width:50%" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cell-norowborder" style="vertical-align:middle;" id="d5190e488"><span><strong class="ph b">Source Files</strong></span></th>
<th class="entry nocellnorowborder" style="vertical-align:middle;" id="d5190e491"><span><strong class="ph b">Usage</strong></span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d5190e488 "><span>app.c</span></td>
<td class="entry row-nocellborder" style="vertical-align:middle;" headers="d5190e491 "><span>Application State machine, includes calls for Initialization of all BLE stack (GAP,GATT, SMP, L2CAP) related component configurations</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d5190e488 "><span>app_ble\app_ble.c</span></td>
<td class="entry row-nocellborder" style="vertical-align:middle;" headers="d5190e491 "><span>Source Code for the BLE stack related component configurations, code related to function calls from app.c</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="vertical-align:middle;" headers="d5190e488 "><span>app_ble\app_ble_handler.c</span></td>
<td class="entry row-nocellborder" style="vertical-align:middle;" headers="d5190e491 "><span>All GAP, GATT, SMP and L2CAP Event handlers</span></td>
</tr>
<tr class="row"><td class="entry cell-norowborder" style="vertical-align:middle;" headers="d5190e488 "><span>ble_button_led_svc.c</span></td>
<td class="entry nocellnorowborder" style="vertical-align:middle;" headers="d5190e491 "><span>All Custom Service button RGB LEDs configurations and functions</span></td>
</tr>
</tbody>
</table>
</div>
app_ble_custom_service header and source files can be copied from the reference application. <blockquote class="lq"><p class="p"><strong class="ph b">Tip:</strong> app.c is autogenerated and has a state machine based Application code sample, users can use this template to develop their application</p>
</blockquote>
<p class="p">The <a class="xref" href="http://ww1.microchip.com/downloads/en/DeviceDoc/MPLAB%20Harmony%20OSAL%20Libraries%20Help%20v2.06.pdf" target="_blank">OSAL</a>, RF System, BLE System initialization routine executed during program initialization can be found in the project files. This initialization routine is automatically generated by the MCC</p>
<div class="p"><div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-1648D94C-8C12-4BE2-A332-FBC7B7F9A656"><div class="figcap"><span class="fig--title-label">Figure 21. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-A3D1D48E-C34D-4E6B-96CA-1E99336228A9-low.jpg" /></div>
</div>
</div>
<div class="section" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__USER-APPLICATION-DEVELOPMENT"><h2 class="title sectiontitle">User Application Development</h2><p class="p">Initialize Advertisement,Custom Service and EIC in APP_Tasks function in file app.c</p>
<p class="p">Add the code for enable advertisement,customer service intilization and button external interrupt callback functions in the APP_STATE_INIT.</p>
<div class="p"><div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-666C4677-447B-4B3B-AAE6-779C291C3E7B"><div class="figcap"><span class="fig--title-label">Figure 22. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-4C16B2E8-48CA-49E7-B166-AFA856B988D0-low.jpg" /></div>
</div>
<pre class="pre codeblock"><code id="d5190e548" content=" /* Application's initial state. */&#xA; case APP_STATE_INIT:&#xA; {  &#xA;    bool appInitialized = true;&#xA;    //appData.appQueue = xQueueCreate( 10, sizeof(APP_Msg_T) );&#xA;    APP_BleStackInit();&#xA;    RTC_Timer32Start();&#xA;    BLE_GAP_SetAdvEnable(0x01, 0); //Enable BLE Advertisement&#xA;    BLE_BUTTON_LED_Add();&#xA;    APP_Button_Init();&#xA;    SYS_CONSOLE_PRINT(&#34;[BLE] Device Initialized. Ready for connection. \r\n&#34;);"> /* Application's initial state. */
 case APP_STATE_INIT:
 {  
    bool appInitialized = true;
    //appData.appQueue = xQueueCreate( 10, sizeof(APP_Msg_T) );
    APP_BleStackInit();
    RTC_Timer32Start();
    BLE_GAP_SetAdvEnable(0x01, 0); //Enable BLE Advertisement
    BLE_BUTTON_LED_Add();
    APP_Button_Init();
    SYS_CONSOLE_PRINT("[BLE] Device Initialized. Ready for connection. \r\n");</code></pre><p class="p">Handle the button and RGB LED events in APP_Tasks function in file app.c</p>
<div class="p">Add the RGB and button handlers to the function APP_Tasks() in app.c file.<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-CDB3118A-41C0-4845-A856-77844A27A46A"><div class="figcap"><span class="fig--title-label">Figure 23. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-1DA2EF15-386B-4D1C-BE65-2F84E23019E9-low.jpg" /></div>
<pre class="pre codeblock"><code id="d5190e560" content=" case APP_STATE_SERVICE_TASKS:&#xA; { &#xA;    if (OSAL_QUEUE_Receive(&amp;appData.appQueue, &amp;appMsg, OSAL_WAIT_FOREVER))&#xA;    {&#xA;     // if(p_appMsg-&gt;msgId==APP_MSG_BLE_STACK_EVT)&#xA;     // {&#xA;     // // Pass BLE Stack Event Message to User Application for handling&#xA;     // APP_BleStackEvtHandler((STACK_Event_T *)p_appMsg-&gt;msgData);&#xA;     // }&#xA;     switch (p_appMsg-&gt;msgId)&#xA;     {&#xA;        case APP_MSG_BLE_STACK_EVT:&#xA;        {&#xA;            APP_BleStackEvtHandler((STACK_Event_T *)p_appMsg-&gt;msgData);&#xA;         }&#xA;         break;&#xA;         case APP_MSG_BLE_CS_LED_EVT:&#xA;         {&#xA;             APP_CustomService_RGB_Handler((uint8_t *)((STACK_Event_T *)p_appMsg-&gt;msgData));&#xA;          }&#xA;          break;&#xA;          case APP_MSG_BLE_CS_BUTTON_EVT:&#xA;          {&#xA;              APP_CustomService_Button_Handler();&#xA;          }&#xA;          break;&#xA;       }&#xA;   }&#xA;  break;&#xA; }"> case APP_STATE_SERVICE_TASKS:
 { 
    if (OSAL_QUEUE_Receive(&amp;appData.appQueue, &amp;appMsg, OSAL_WAIT_FOREVER))
    {
     // if(p_appMsg-&gt;msgId==APP_MSG_BLE_STACK_EVT)
     // {
     // // Pass BLE Stack Event Message to User Application for handling
     // APP_BleStackEvtHandler((STACK_Event_T *)p_appMsg-&gt;msgData);
     // }
     switch (p_appMsg-&gt;msgId)
     {
        case APP_MSG_BLE_STACK_EVT:
        {
            APP_BleStackEvtHandler((STACK_Event_T *)p_appMsg-&gt;msgData);
         }
         break;
         case APP_MSG_BLE_CS_LED_EVT:
         {
             APP_CustomService_RGB_Handler((uint8_t *)((STACK_Event_T *)p_appMsg-&gt;msgData));
          }
          break;
          case APP_MSG_BLE_CS_BUTTON_EVT:
          {
              APP_CustomService_Button_Handler();
          }
          break;
       }
   }
  break;
 }</code></pre>Add the msg ids for the button and RGB LED events in file app.h</div>
<div class="p"><div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-C0A99A2E-51C8-47F5-956A-26AF081E0321"><div class="figcap"><span class="fig--title-label">Figure 24. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-F9534D10-4FF8-4223-952E-0CE37530DFB7-low.jpg" /></div>
<pre class="pre codeblock"><code id="d5190e570" content=" typedef enum APP_MsgId_T&#xA; {&#xA;     APP_MSG_BLE_STACK_EVT,&#xA;     APP_MSG_ZB_STACK_EVT,&#xA;     APP_MSG_ZB_STACK_CB,&#xA;     APP_MSG_BLE_CS_LED_EVT,&#xA;     APP_MSG_BLE_CS_BUTTON_EVT,&#xA;     APP_MSG_STACK_END&#xA; } APP_MsgId_T;"> typedef enum APP_MsgId_T
 {
     APP_MSG_BLE_STACK_EVT,
     APP_MSG_ZB_STACK_EVT,
     APP_MSG_ZB_STACK_CB,
     APP_MSG_BLE_CS_LED_EVT,
     APP_MSG_BLE_CS_BUTTON_EVT,
     APP_MSG_STACK_END
 } APP_MsgId_T;</code></pre><strong class="ph b">Add the custom service file(\custom_service\firmware\src\app_ble_custom_service.c/.h) which has the supporting functions for Button LED Custom service file.</strong><div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-C38AAF6A-B04B-45DB-A148-9A8220EB8C6A"><div class="figcap"><span class="fig--title-label">Figure 25. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-E1F1525A-6136-4BA4-AC0C-1A0AA07D7FEC-low.jpg" /></div>
<strong class="ph b">Print the required information on the connect and discoonect events in file app_ble_handler.c</strong>Add the required variables, functions and callback handlers for GATT read/write response in the file ble_handler.c along with the connect and disconnect .</div>
<div class="p"><div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-1043A29C-B407-4AEA-AAFC-232899ADF64B"><div class="figcap"><span class="fig--title-label">Figure 26. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-6A62AD51-A10B-4811-8867-4EA526680D87-low.jpg" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-E48B55E5-9AD6-458C-AE9D-38E0F270D19D"><div class="figcap"><span class="fig--title-label">Figure 27. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-1CCB6B6A-7686-48C1-A052-D83277373FB7-low.jpg" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-561295B0-4D61-4040-BE77-434B15B56A1F"><div class="figcap"><span class="fig--title-label">Figure 28. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-AC05D225-E588-440C-8AB3-0553B3AAD97C-low.jpg" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-DDB3A432-6EAF-4BA9-A876-35464295E261"><div class="figcap"><span class="fig--title-label">Figure 29. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-FFD8E8E4-4E5D-46E3-B61E-4292E720062A-low.jpg" /></div>
<pre class="pre codeblock"><code id="d5190e608" content="void APP_BleGapEvtHandler(BLE_GAP_Event_T *p_event)&#xA;{ &#xA;    switch(p_event-&gt;eventId)&#xA;    {&#xA;        case BLE_GAP_EVT_CONNECTED:&#xA;        {&#xA;        /* TODO: implement your application code.*/&#xA;        SYS_CONSOLE_PRINT(&#34;[BLE] Connected to Peer Device: 0x&#34;);&#xA;        for(int8_t idx=(GAP_MAX_BD_ADDRESS_LEN-1); idx&gt;=0; idx--)&#xA;        {&#xA;            SYS_CONSOLE_PRINT(&#34;%02x&#34;, p_event-&gt;eventField.evtConnect.remoteAddr.addr[idx]);&#xA;        }&#xA;        SYS_CONSOLE_PRINT(&#34;\n\r[BLE] Connection Handle: %d\n\r&#34;,p_event-&gt;eventField.evtConnect.connHandle);&#xA;        G_ConnHandle = p_event-&gt;eventField.evtConnect.connHandle;&#xA;        }&#xA;        break;&#xA;        case BLE_GAP_EVT_DISCONNECTED:&#xA;        {&#xA;           /* TODO: implement your application code.*/&#xA;           SYS_CONSOLE_PRINT(&#34;[BLE] Disconnected Handle: %d, Reason: 0x%X\n\r&#34;,p_event-&gt;eventField.evtDisconnect.connHandle, p_event-&gt;eventField.evtDisconnect.reason);&#xA;           G_ConnHandle = 0;&#xA;           BLE_GAP_SetAdvEnable(0x01, 0); //Enable BLE Advertisement          &#xA;        }&#xA;        break;">void APP_BleGapEvtHandler(BLE_GAP_Event_T *p_event)
{ 
    switch(p_event-&gt;eventId)
    {
        case BLE_GAP_EVT_CONNECTED:
        {
        /* TODO: implement your application code.*/
        SYS_CONSOLE_PRINT("[BLE] Connected to Peer Device: 0x");
        for(int8_t idx=(GAP_MAX_BD_ADDRESS_LEN-1); idx&gt;=0; idx--)
        {
            SYS_CONSOLE_PRINT("%02x", p_event-&gt;eventField.evtConnect.remoteAddr.addr[idx]);
        }
        SYS_CONSOLE_PRINT("\n\r[BLE] Connection Handle: %d\n\r",p_event-&gt;eventField.evtConnect.connHandle);
        G_ConnHandle = p_event-&gt;eventField.evtConnect.connHandle;
        }
        break;
        case BLE_GAP_EVT_DISCONNECTED:
        {
           /* TODO: implement your application code.*/
           SYS_CONSOLE_PRINT("[BLE] Disconnected Handle: %d, Reason: 0x%X\n\r",p_event-&gt;eventField.evtDisconnect.connHandle, p_event-&gt;eventField.evtDisconnect.reason);
           G_ConnHandle = 0;
           BLE_GAP_SetAdvEnable(0x01, 0); //Enable BLE Advertisement          
        }
        break;</code></pre><strong class="ph b">Add the functions for the GATT read and write handlers which will act on the received GATT request in file app_ble_handler.c.</strong></div>
<div class="p"><div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-C13CE78F-C5AE-4380-BB9B-67E952264C38"><div class="figcap"><span class="fig--title-label">Figure 30. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-34FB5A07-51FE-43F1-830E-0A00CF146187-low.jpg" /></div>
<div class="fig fignone" id="GUID-0F3193BF-C61D-4DDB-9E98-7F0A444269A8__GUID-722066F7-43E3-4ED8-A295-FFC1D35E5325"><div class="figcap"><span class="fig--title-label">Figure 31. </span>. </div><span class="desc figdesc"></span><img class="image" src="GUID-EEF7878D-6521-473E-BC01-7617117C5325-low.jpg" /></div>
<pre class="pre codeblock"><code id="d5190e625" content="void APP_GattSEvtReadHandler(GATT_EvtRead_T p_event)&#xA;{&#xA;&#xA;    uint8_t error = 0;&#xA;    uint16_t status;&#xA;    SYS_CONSOLE_PRINT(&#34;[BLE] GATT Read ATTR Handle 0x%X \r\n&#34;,p_event.attrHandle);&#xA;    &#xA;    if ((p_event.attrHandle &lt;= BUTTON_LED_START_HDL) ||&#xA;        (p_event.attrHandle &gt; BUTTON_LED_END_HDL))&#xA;    {&#xA;        /* Not BLE Custom Service characteristic. */&#xA;        return;&#xA;    }&#xA;&#xA;        switch(p_event.attrHandle)&#xA;        {&#xA;            case BUTTON_LED_HDL_CHAR_0:                            /**&lt; Handle of characteristic 0. */&#xA;            case BUTTON_LED_HDL_CCCD_0:                            /**&lt; Handle of characteristic 0 CCCD . */&#xA;            case BUTTON_LED_HDL_CHAR_1:                            /**&lt; Handle of characteristic 1. */&#xA;            case BUTTON_LED_HDL_CHARVAL_1:                         /**&lt; Handle of characteristic 1 value. */&#xA;                error = ATT_ERRCODE_APPLICATION_ERROR;&#xA;                break;&#xA;            case BUTTON_LED_HDL_CHARVAL_0:                         /**&lt; Handle of characteristic 0 value. */                &#xA;//                SYS_CONSOLE_PRINT(&#34; ATTR Handle Read 0x%X \r\n&#34;,p_event.attrHandle);&#xA;                break;&#xA;        }&#xA;&#xA;    if ((p_event.readType == ATT_READ_REQ)&#xA;    || (p_event.readType == ATT_READ_BLOB_REQ))&#xA;    {&#xA;        if (!error)&#xA;        {&#xA;            sp_trsReadRespParams = (GATTS_SendReadRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendReadRespParams_T));&#xA;            if (sp_trsReadRespParams == NULL)&#xA;            {&#xA;                return;&#xA;            }&#xA;            trsRespErrConnHandle = p_event.connHandle;&#xA;            sp_trsReadRespParams-&gt;responseType = ATT_READ_RSP;&#xA;            sp_trsReadRespParams-&gt;attrLength = 0x01;&#xA;            sp_trsReadRespParams-&gt;attrValue[0]= bleCSdata.rgbOnOffStatus;            &#xA;//            sp_trsReadRespParams-&gt;attrLength = 0x03;&#xA;//            sp_trsReadRespParams-&gt;attrValue[0]= bleCSdata.RGB_LED.Red;&#xA;//            sp_trsReadRespParams-&gt;attrValue[1]= bleCSdata.RGB_LED.Green;&#xA;//            sp_trsReadRespParams-&gt;attrValue[2]= bleCSdata.RGB_LED.Blue;&#xA;            status = GATTS_SendReadResponse(p_event.connHandle, sp_trsReadRespParams);&#xA;            if (status == MBA_RES_SUCCESS)&#xA;            {&#xA;                OSAL_Free(sp_trsReadRespParams);&#xA;                sp_trsReadRespParams = NULL;&#xA;            }&#xA;        }&#xA;        else&#xA;        {&#xA;            sp_trsErrParams = (GATTS_SendErrRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendErrRespParams_T));&#xA;            if (sp_trsErrParams == NULL)&#xA;            {&#xA;                return;&#xA;            }&#xA;            trsRespErrConnHandle = p_event.connHandle;&#xA;            sp_trsErrParams-&gt;reqOpcode = p_event.readType;&#xA;            sp_trsErrParams-&gt;attrHandle = p_event.attrHandle;&#xA;            sp_trsErrParams-&gt;errorCode = error;&#xA;            status = GATTS_SendErrorResponse(p_event.connHandle, sp_trsErrParams);&#xA;            if (status == MBA_RES_SUCCESS)&#xA;            {&#xA;                OSAL_Free(sp_trsErrParams);&#xA;                sp_trsErrParams = NULL;&#xA;            }&#xA;        }&#xA;    }   &#xA;}">void APP_GattSEvtReadHandler(GATT_EvtRead_T p_event)
{

    uint8_t error = 0;
    uint16_t status;
    SYS_CONSOLE_PRINT("[BLE] GATT Read ATTR Handle 0x%X \r\n",p_event.attrHandle);
    
    if ((p_event.attrHandle &lt;= BUTTON_LED_START_HDL) ||
        (p_event.attrHandle &gt; BUTTON_LED_END_HDL))
    {
        /* Not BLE Custom Service characteristic. */
        return;
    }

        switch(p_event.attrHandle)
        {
            case BUTTON_LED_HDL_CHAR_0:                            /**&lt; Handle of characteristic 0. */
            case BUTTON_LED_HDL_CCCD_0:                            /**&lt; Handle of characteristic 0 CCCD . */
            case BUTTON_LED_HDL_CHAR_1:                            /**&lt; Handle of characteristic 1. */
            case BUTTON_LED_HDL_CHARVAL_1:                         /**&lt; Handle of characteristic 1 value. */
                error = ATT_ERRCODE_APPLICATION_ERROR;
                break;
            case BUTTON_LED_HDL_CHARVAL_0:                         /**&lt; Handle of characteristic 0 value. */                
//                SYS_CONSOLE_PRINT(" ATTR Handle Read 0x%X \r\n",p_event.attrHandle);
                break;
        }

    if ((p_event.readType == ATT_READ_REQ)
    || (p_event.readType == ATT_READ_BLOB_REQ))
    {
        if (!error)
        {
            sp_trsReadRespParams = (GATTS_SendReadRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendReadRespParams_T));
            if (sp_trsReadRespParams == NULL)
            {
                return;
            }
            trsRespErrConnHandle = p_event.connHandle;
            sp_trsReadRespParams-&gt;responseType = ATT_READ_RSP;
            sp_trsReadRespParams-&gt;attrLength = 0x01;
            sp_trsReadRespParams-&gt;attrValue[0]= bleCSdata.rgbOnOffStatus;            
//            sp_trsReadRespParams-&gt;attrLength = 0x03;
//            sp_trsReadRespParams-&gt;attrValue[0]= bleCSdata.RGB_LED.Red;
//            sp_trsReadRespParams-&gt;attrValue[1]= bleCSdata.RGB_LED.Green;
//            sp_trsReadRespParams-&gt;attrValue[2]= bleCSdata.RGB_LED.Blue;
            status = GATTS_SendReadResponse(p_event.connHandle, sp_trsReadRespParams);
            if (status == MBA_RES_SUCCESS)
            {
                OSAL_Free(sp_trsReadRespParams);
                sp_trsReadRespParams = NULL;
            }
        }
        else
        {
            sp_trsErrParams = (GATTS_SendErrRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendErrRespParams_T));
            if (sp_trsErrParams == NULL)
            {
                return;
            }
            trsRespErrConnHandle = p_event.connHandle;
            sp_trsErrParams-&gt;reqOpcode = p_event.readType;
            sp_trsErrParams-&gt;attrHandle = p_event.attrHandle;
            sp_trsErrParams-&gt;errorCode = error;
            status = GATTS_SendErrorResponse(p_event.connHandle, sp_trsErrParams);
            if (status == MBA_RES_SUCCESS)
            {
                OSAL_Free(sp_trsErrParams);
                sp_trsErrParams = NULL;
            }
        }
    }   
}</code></pre><pre class="pre codeblock"><code id="d5190e627" content="void APP_GattSEvtWriteHandler(GATT_EvtWrite_T p_event)&#xA;{&#xA;    uint8_t error = 0;&#xA;    uint16_t status;&#xA;    SYS_CONSOLE_PRINT(&#34;[BLE] GATT Write ATTR Handle 0x%X \r\n&#34;,p_event.attrHandle);&#xA;    &#xA;    if ((p_event.attrHandle &lt;= BUTTON_LED_START_HDL) ||&#xA;        (p_event.attrHandle &gt; BUTTON_LED_END_HDL))&#xA;    {&#xA;        /* Not BLE Custom Service characteristic. */&#xA;        error = ATT_ERRCODE_INVALID_HANDLE;&#xA;        return;&#xA;    }&#xA;    &#xA;        switch(p_event.attrHandle)&#xA;        {&#xA;            case BUTTON_LED_HDL_CHAR_0:                            /**&lt; Handle of characteristic 0. */&#xA;            case BUTTON_LED_HDL_CHARVAL_0:                         /**&lt; Handle of characteristic 0 value. */&#xA;            case BUTTON_LED_HDL_CCCD_0:                            /**&lt; Handle of characteristic 0 CCCD . */&#xA;            case BUTTON_LED_HDL_CHAR_1:                            /**&lt; Handle of characteristic 1. */&#xA;                error = ATT_ERRCODE_APPLICATION_ERROR;&#xA;                break;&#xA;            case BUTTON_LED_HDL_CHARVAL_1:                         /**&lt; Handle of characteristic 1 value. */&#xA;//                SYS_CONSOLE_PRINT(&#34; ATTR Handle %d \r\n&#34;,p_event.attrHandle);&#xA;                APP_CustomService_RGB_Callback(p_event.writeValue);&#xA;                break;&#xA;        }&#xA;&#xA;    if ((p_event.writeType == ATT_WRITE_REQ)&#xA;    || (p_event.writeType == ATT_PREPARE_WRITE_REQ))&#xA;    {&#xA;        if (!error)&#xA;        {&#xA;            sp_trsRespParams = (GATTS_SendWriteRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendWriteRespParams_T));&#xA;            if (sp_trsRespParams == NULL)&#xA;            {&#xA;                return;&#xA;            }&#xA;            trsRespErrConnHandle = p_event.connHandle;&#xA;            sp_trsRespParams-&gt;responseType = ATT_WRITE_RSP;&#xA;            status = GATTS_SendWriteResponse(p_event.connHandle, sp_trsRespParams);&#xA;            if (status == MBA_RES_SUCCESS)&#xA;            {&#xA;                OSAL_Free(sp_trsRespParams);&#xA;                sp_trsRespParams = NULL;&#xA;            }&#xA;        }&#xA;        else&#xA;        {&#xA;            sp_trsErrParams = (GATTS_SendErrRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendErrRespParams_T));&#xA;            if (sp_trsErrParams == NULL)&#xA;            {&#xA;                return;&#xA;            }&#xA;            trsRespErrConnHandle = p_event.connHandle;&#xA;            sp_trsErrParams-&gt;reqOpcode = p_event.writeType;&#xA;            sp_trsErrParams-&gt;attrHandle = p_event.attrHandle;&#xA;            sp_trsErrParams-&gt;errorCode = error;&#xA;            status = GATTS_SendErrorResponse(p_event.connHandle, sp_trsErrParams);&#xA;            if (status == MBA_RES_SUCCESS)&#xA;            {&#xA;                OSAL_Free(sp_trsErrParams);&#xA;                sp_trsErrParams = NULL;&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;">void APP_GattSEvtWriteHandler(GATT_EvtWrite_T p_event)
{
    uint8_t error = 0;
    uint16_t status;
    SYS_CONSOLE_PRINT("[BLE] GATT Write ATTR Handle 0x%X \r\n",p_event.attrHandle);
    
    if ((p_event.attrHandle &lt;= BUTTON_LED_START_HDL) ||
        (p_event.attrHandle &gt; BUTTON_LED_END_HDL))
    {
        /* Not BLE Custom Service characteristic. */
        error = ATT_ERRCODE_INVALID_HANDLE;
        return;
    }
    
        switch(p_event.attrHandle)
        {
            case BUTTON_LED_HDL_CHAR_0:                            /**&lt; Handle of characteristic 0. */
            case BUTTON_LED_HDL_CHARVAL_0:                         /**&lt; Handle of characteristic 0 value. */
            case BUTTON_LED_HDL_CCCD_0:                            /**&lt; Handle of characteristic 0 CCCD . */
            case BUTTON_LED_HDL_CHAR_1:                            /**&lt; Handle of characteristic 1. */
                error = ATT_ERRCODE_APPLICATION_ERROR;
                break;
            case BUTTON_LED_HDL_CHARVAL_1:                         /**&lt; Handle of characteristic 1 value. */
//                SYS_CONSOLE_PRINT(" ATTR Handle %d \r\n",p_event.attrHandle);
                APP_CustomService_RGB_Callback(p_event.writeValue);
                break;
        }

    if ((p_event.writeType == ATT_WRITE_REQ)
    || (p_event.writeType == ATT_PREPARE_WRITE_REQ))
    {
        if (!error)
        {
            sp_trsRespParams = (GATTS_SendWriteRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendWriteRespParams_T));
            if (sp_trsRespParams == NULL)
            {
                return;
            }
            trsRespErrConnHandle = p_event.connHandle;
            sp_trsRespParams-&gt;responseType = ATT_WRITE_RSP;
            status = GATTS_SendWriteResponse(p_event.connHandle, sp_trsRespParams);
            if (status == MBA_RES_SUCCESS)
            {
                OSAL_Free(sp_trsRespParams);
                sp_trsRespParams = NULL;
            }
        }
        else
        {
            sp_trsErrParams = (GATTS_SendErrRespParams_T *)OSAL_Malloc(sizeof(GATTS_SendErrRespParams_T));
            if (sp_trsErrParams == NULL)
            {
                return;
            }
            trsRespErrConnHandle = p_event.connHandle;
            sp_trsErrParams-&gt;reqOpcode = p_event.writeType;
            sp_trsErrParams-&gt;attrHandle = p_event.attrHandle;
            sp_trsErrParams-&gt;errorCode = error;
            status = GATTS_SendErrorResponse(p_event.connHandle, sp_trsErrParams);
            if (status == MBA_RES_SUCCESS)
            {
                OSAL_Free(sp_trsErrParams);
                sp_trsErrParams = NULL;
            }
        }
    }
}
</code></pre></div>
<p class="p"><strong class="ph b">Tip:</strong> Manual read and write response,permissions and other standard events like GAP and GATT can be executed in the app_ble_handler</p>
<p class="p">Users can exercise various other BLE functionalities by using<a class="xref" href="https://onlinedocs.microchip.com/pr/GUID-C5EAF60E-9124-427C-A0F1-F2DBE662EA92-en-US-1/index.html" target="_blank">BLE Stack API</a></p>
</div>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-B3B46369-F5B4-401B-8405-658BE34988F4.html">Peripheral</a></div>
</div>
</div></body>
</html>